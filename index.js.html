<script>
// =============================================================================
// Fisio System – Frontend (UTF-8, estruturado e estável)
// =============================================================================

// Estado global
var currentUser = null;
var currentPatient = null;
var currentEncounter = null;
var INITIAL_PATIENTS = [];
if (!window.ENCOUNTERS_CACHE_BY_ID) window.ENCOUNTERS_CACHE_BY_ID = {};

// =============================================================================
// Boot
// =============================================================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ Sistema iniciado');
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    showError('Sistema não inicializado. Acesse via URL do Web App.');
    return;
  }
  loadUser();
  try { if (typeof PATIENTS_DATA !== 'undefined' && PATIENTS_DATA) { INITIAL_PATIENTS = PATIENTS_DATA; updateDashboardStats(PATIENTS_DATA.length); } } catch (e) {}

  var items = document.querySelectorAll('#sidebar [data-route]');
  for (var i = 0; i < items.length; i++) {
    items[i].addEventListener('click', function(e){
      e.preventDefault();
      var route = this.getAttribute('data-route');
      if (!route) return;
      var navItems = document.querySelectorAll('#sidebar .nav-item');
      for (var j=0;j<navItems.length;j++) navItems[j].classList.remove('is-active');
      this.classList.add('is-active');
      showTab(route);
      if (window.innerWidth <= 1024) {
        var s = document.getElementById('sidebar');
        var o = document.getElementById('sidebar-overlay');
        if (s) s.classList.remove('open');
        if (o) o.classList.add('hidden');
      }
    });
  }
  showTab('dashboard');
});

function toggleSidebar(){ var s=document.getElementById('sidebar'); var o=document.getElementById('sidebar-overlay'); if (s) s.classList.toggle('open'); if (o) o.classList.toggle('hidden'); }

// =============================================================================
// Utils
// =============================================================================
function debugLog(msg, data){ try{ console.log(msg, data); }catch(e){} }
function escapeHtml(text){ if (!text && text !== 0) return ''; var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }; return String(text).replace(/[&<>\"']/g, function(m){ return map[m] || m; }); }
function showLoading(){ var el=document.getElementById('loading'); if(el) el.classList.remove('hidden'); }
function hideLoading(){ var el=document.getElementById('loading'); if(el) el.classList.add('hidden'); }
function showSuccess(m){ console.log('[SUCCESS]', m); }
function showError(m){ console.error('[ERROR]', m); }
function calculateAge(b){ if(!b) return '-'; try{var t=new Date(),d=new Date(b),a=t.getFullYear()-d.getFullYear(),m=t.getMonth()-d.getMonth(); if(m<0||(m===0&&t.getDate()<d.getDate())) a--; return isNaN(a)?'-':a;}catch(e){return '-';} }
function formatCPF(c){ if(!c) return ''; var n=String(c).replace(/\D/g,''); return n.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); }
function formatDateTime(iso){ if(!iso) return '-'; try{ var d=new Date(iso); var dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear(), hh=('0'+d.getHours()).slice(-2), mi=('0'+d.getMinutes()).slice(-2); return dd+'/'+mm+'/'+yy+' '+hh+':'+mi; }catch(e){ return '-'; } }
function formatDateBR(iso){ if(!iso) return '__/__/____'; try{ var d=new Date(iso); var dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear(); return dd+'/'+mm+'/'+yy; }catch(e){ return '__/__/____'; } }
function getInitials(name){ if(!name) return '??'; var p=String(name).trim().split(/\s+/); return ((p[0]||'').charAt(0)+(p.length>1?(p[p.length-1]||'').charAt(0):'')).toUpperCase()||'??'; }

// =============================================================================
// Usuário
// =============================================================================
function loadUser(){ showLoading(); google.script.run.withSuccessHandler(function(user){ hideLoading(); if(!user||!user.role){ showError('Acesso negado.'); return; } currentUser=user; var n=document.getElementById('user-name'); if(n) n.textContent=user.email||''; var r=document.getElementById('user-role'); if(r) r.textContent=user.role||''; }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao carregar usuário: '+(err.message||err)); }).handleApiGet({path:'/api/user'}); }

// =============================================================================
// Dashboard
// =============================================================================
function updateDashboardStats(count){ var s=document.getElementById('stat-patients'); if(s) s.textContent=count; var b=document.getElementById('badge-pacientes'); if(b){ b.textContent=count||0; b.style.display='inline-block'; } }
function loadDashboardStats(){ updateDashboardStats(INITIAL_PATIENTS.length); }

// =============================================================================
// Header + Abas
// =============================================================================
function updatePageHeader(tab){ var t=document.getElementById('page-title'), s=document.getElementById('page-subtitle'), a=document.getElementById('page-actions'); var cfg={ dashboard:{title:'Dashboard', subtitle:'Visão geral do sistema de fisioterapia', actions:'<button class=\"btn-primary\" onclick=\"showProfessionalModalFromDashboard()\"><i class=\"fas fa-user-md mr-2\"></i> Cadastrar Profissional</button>'}, patients:{title:'Pacientes', subtitle:'Gerenciamento de pacientes cadastrados', actions:'<button class=\"btn-primary\" onclick=\"showNewPatientModal()\"><i class=\"fas fa-plus mr-2\"></i> Novo Paciente</button>'}, encounters:{title:'Atendimentos', subtitle:'Registro e acompanhamento de atendimentos', actions:''}, reports:{title:'Relatórios', subtitle:'Geração de documentos e Relatórios', actions:''}, agenda:{title:'Agenda', subtitle:'Planejamento semanal e atendimentos', actions:''}, professionals:{title:'Profissionais', subtitle:'Cadastro e gerenciamento da equipe', actions:'<button class=\"btn-primary\" onclick=\"showProfessionalModalFromDashboard()\"><i class=\"fas fa-plus mr-2\"></i> Novo Profissional</button>'} }[tab]||{title:'Fisio System',subtitle:'',actions:''}; if(t) t.textContent=cfg.title; if(s) s.textContent=cfg.subtitle; if(a) a.innerHTML=cfg.actions; }
function showTab(tab){ var tabs=document.querySelectorAll('.tab-content'); for(var i=0;i<tabs.length;i++) tabs[i].classList.add('hidden'); var el=document.getElementById(tab+'-tab'); if(el) el.classList.remove('hidden'); updatePageHeader(tab); if(tab==='dashboard') loadDashboardStats(); else if(tab==='patients') loadPatients(); else if(tab==='encounters') loadEncountersTab(); else if(tab==='reports') loadPatientsForReport(); else if(tab==='professionals') loadProfessionalsTab(); else if(tab==='agenda') loadAgendaTab(); }

// =============================================================================
// Pacientes (lista / busca / CRUD / status) – resumo
// =============================================================================
function loadPatients(){ if(INITIAL_PATIENTS.length>0){ renderPatientsList(INITIAL_PATIENTS); return; } showLoading(); google.script.run.withSuccessHandler(function(p){ hideLoading(); INITIAL_PATIENTS=Array.isArray(p)?p:[]; renderPatientsList(INITIAL_PATIENTS); updateDashboardStats(INITIAL_PATIENTS.length); }).withFailureHandler(function(e){ hideLoading(); showError('Erro ao carregar pacientes: '+(e.message||e)); renderPatientsList([]); }).getFrontendPatients(); }
function renderPatientsList(list){ var c=document.getElementById('patients-list'); if(!c) return; if(!Array.isArray(list)||list.length===0){ c.innerHTML='<div class=\"empty-state\"><i class=\"fas fa-user-friends\"></i><h3>Nenhum paciente cadastrado</h3><p>Clique em "Novo Paciente" para cadastrar o primeiro</p></div>'; return; } var html=''; for(var i=0;i<list.length;i++){ var p=list[i], age=calculateAge(p.birth_date), initials=getInitials(p.full_name), sexIcon=p.sex==='M'?'mars':'venus', sexTxt=p.sex==='M'?'Masculino':'Feminino', status=(p.status==='ACTIVE'||!p.status)?'active':'inactive'; html+='<div class=\"patient-card\" onclick=\"viewPatient(\''+p.id+'\')\"><div class=\"patient-status-badge '+status+'\">'+(p.status==='ACTIVE'?'Ativo':'Inativo')+'</div><div class=\"patient-card-header\"><div class=\"patient-avatar\">'+escapeHtml(initials)+'</div><div class=\"patient-info\"><div class=\"patient-name\">'+escapeHtml(p.full_name||'')+'</div><div class=\"patient-meta\"><span class=\"patient-meta-item\"><i class=\"fas fa-'+sexIcon+'\"></i><span>'+sexTxt+'</span></span><span class=\"patient-meta-item\"><i class=\"fas fa-birthday-cake\"></i><span>'+age+' anos</span></span></div></div></div><div class=\"patient-card-body\"><div class=\"patient-detail-row\"><i class=\"fas fa-id-card\"></i><span>CPF: '+formatCPF(p.document_id||'')+'</span></div></div><div class=\"patient-card-footer\"><button onclick=\"event.stopPropagation(); startEncounter(\''+p.id+'\')\" class=\"btn-card-action primary\"><i class=\"fas fa-play\"></i><span>Atender</span></button><button onclick=\"event.stopPropagation(); editPatient(\''+p.id+'\')\" class=\"btn-card-action\"><i class=\"fas fa-edit\"></i><span>Editar</span></button><button onclick=\"event.stopPropagation(); changePatientStatus(\''+p.id+'\')\" class=\"btn-card-action\"><i class=\"fas fa-exchange-alt\"></i></button></div></div>'; } c.innerHTML=html; }
function searchPatients(){ var q=(document.getElementById('patient-search')?.value||'').toLowerCase(); if(q.length<2){ renderPatientsList(INITIAL_PATIENTS); return; } renderPatientsList(INITIAL_PATIENTS.filter(function(p){ return (p.full_name||'').toLowerCase().indexOf(q)!==-1 || String(p.document_id||'').indexOf(q)!==-1; })); }
// Substituído por implementação completa ao final do arquivo (overrides)

// =============================================================================
// Profissionais
// =============================================================================
function loadProfessionalsForEncounter(){ var sel=document.getElementById('encounter-professional'); if(!sel) return; sel.innerHTML='<option value=\"\">Carregando profissionais...</option>'; google.script.run.withSuccessHandler(function(resp){ var list=(resp&&resp.data)||[]; if(!list.length){ sel.innerHTML='<option value=\"\">Nenhum profissional encontrado</option>'; return; } var html='<option value=\"\">Selecione o profissional...</option>'; list.forEach(function(p){ var label=(p.full_name||p.email||p.id||''); var cref=p.crefito?(' - CREFITO: '+p.crefito):''; html+='<option value=\"'+p.id+'\">'+escapeHtml(label)+cref+'</option>'; }); sel.innerHTML=html; }).withFailureHandler(function(err){ sel.innerHTML='<option value=\"\">Erro ao carregar</option>'; showError('Erro ao carregar profissionais: '+(err.message||err)); }).handleApiGet({path:'/api/professionals'}); }
function loadProfessionalsTab(){ var c=document.getElementById('professionals-list'); if(!c) return; c.innerHTML='<p class=\"text-gray-500 text-center py-8\">Carregando profissionais...</p>'; google.script.run.withSuccessHandler(function(resp){ var list=(resp&&resp.data)||[]; if(!list.length){ c.innerHTML='<div class=\"text-center py-12 text-gray-400\"><i class=\"fas fa-user-md text-6xl mb-4\"></i><p class=\"text-lg\">Nenhum profissional cadastrado</p></div>'; return; } var h='<div class=\"space-y-3\">'; list.forEach(function(p){ h+='<div class=\"flex justify-between items-center bg-white border rounded p-3\"><div class=\"text-gray-800 font-medium\">'+escapeHtml(p.full_name||p.email||p.id||'')+'</div><div class=\"text-xs text-gray-500\">'+escapeHtml(p.role||'')+'</div></div>'; }); h+='</div>'; c.innerHTML=h; }).withFailureHandler(function(){ c.innerHTML='<p class=\"text-red-500 text-center py-8\">Erro ao carregar profissionais</p>'; }).handleApiGet({path:'/api/professionals'}); }

// =============================================================================
// Atendimentos – fluxo e listagem
// =============================================================================
function startEncounter(patientId){ var p=INITIAL_PATIENTS.find(function(x){return x.id===patientId;}); if(!p){ showError('Paciente não encontrado'); return; } currentPatient=p; showEncounterModal(); }
function showEncounterModal(){ showError('Fluxo de atendimento resumido nesta versão.'); }
function loadEncountersTab(){ var sel=document.getElementById('encounter-patient-filter'); if(!sel) return; if(INITIAL_PATIENTS.length===0){ google.script.run.withSuccessHandler(function(p){ INITIAL_PATIENTS=p||[]; populatePatientSelect(); }).withFailureHandler(function(){ sel.innerHTML='<option value=\"\">Erro ao carregar pacientes</option>'; }).getFrontendPatients(); return; } populatePatientSelect(); }
function populatePatientSelect(){ var sel=document.getElementById('encounter-patient-filter'); if(!sel) return; var h='<option value=\"\">Selecione um paciente...</option>'; INITIAL_PATIENTS.forEach(function(p){ h+='<option value=\"'+p.id+'\">'+escapeHtml(p.full_name)+' - '+calculateAge(p.birth_date)+' anos - CPF: '+escapeHtml(p.document_id||'')+'</option>'; }); sel.innerHTML=h; }
function loadPatientEncounters(){
  var id=(document.getElementById('encounter-patient-filter')||{}).value||'';
  var list=document.getElementById('encounters-list');
  if(!id){ if(list) list.innerHTML='<div class="text-center py-12 text-gray-400"><i class="fas fa-filter text-6xl mb-4"></i><p class="text-lg">Nenhum paciente selecionado</p></div>'; return; }
  showLoading();
  google.script.run
    .withSuccessHandler(function(resp){
      hideLoading();
      var encs=(resp&&resp.data)||[];
      if(!encs.length){ list.innerHTML='<div class="text-center py-12 text-gray-400"><i class="fas fa-clipboard text-6xl mb-4"></i><p class="text-lg">Nenhum atendimento encontrado</p></div>'; return; }
      var h='<div class="space-y-4">';
      encs.forEach(function(enc){
        try{ window.ENCOUNTERS_CACHE_BY_ID[enc.id]=enc; }catch(e){}
        var badge=enc.status==='OPEN'?'<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Em Andamento</span>':'<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Finalizado</span>';
        h+=
          '<div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">'+
            '<div class="flex justify-between items-start mb-3">'+
              '<div>'+ 
                '<h3 class="font-bold text-lg text-gray-800"><i class="fas fa-stethoscope text-blue-600 mr-2"></i>'+escapeHtml(enc.type||'')+'</h3>'+ 
                '<p class="text-sm text-gray-600"><i class="fas fa-user-md mr-1"></i>'+escapeHtml(enc.professional_name||'')+'</p>'+ 
              '</div>'+ 
              badge+
            '</div>'+ 
            '<div class="grid grid-cols-2 gap-3 text-sm mb-3">'+
              '<div><span class="text-gray-500">Início:</span><span class="font-medium ml-1">'+formatDateTime(enc.started_at)+'</span></div>'+ 
              '<div><span class="text-gray-500">Fim:</span><span class="font-medium ml-1">'+(enc.ended_at?formatDateTime(enc.ended_at):'-')+'</span></div>'+ 
              '<div><span class="text-gray-500">Local:</span><span class="font-medium ml-1">'+escapeHtml(enc.location||'')+'</span></div>'+ 
            '</div>'+ 
            '<div class="flex gap-2 pt-3 border-t">'+
              '<button onclick="viewEncounterDetails(\''+enc.id+'\')" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200"><i class="fas fa-eye mr-1"></i>Ver Detalhes</button>'+ 
              '<button onclick="editEncounter(\''+enc.id+'\')" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200"><i class="fas fa-edit mr-1"></i>Editar</button>'+ 
            '</div>'+ 
          '</div>';
      });
      h+='</div>';
      list.innerHTML=h;
    })
    .withFailureHandler(function(err){ hideLoading(); showError('Erro ao buscar atendimentos: '+(err.message||err)); })
    .handleApiGet({path:'/api/encounters/patient', patient_id:id});
}

// Edição simples de atendimento: permite anexar nova nota SOAP e novos sinais
function editEncounter(encounterId){
  // Carrega detalhes (para contexto) e abre modal de edição simples
  showLoading();
  google.script.run
    .withSuccessHandler(function(details){
      hideLoading();
      openEditEncounterModal(encounterId, details||{});
    })
    .withFailureHandler(function(){ hideLoading(); openEditEncounterModal(encounterId, {}); })
    .getEncounterDetails(encounterId);
}

function openEditEncounterModal(encounterId, details){
  var html = ''+
    '<div id="edit-encounter-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">'+
      '<div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">'+
        '<div class="bg-blue-600 text-white px-6 py-3 rounded-t-lg flex justify-between items-center">'+
          '<h3 class="text-lg font-bold"><i class="fas fa-clipboard-list mr-2"></i>Editar Atendimento</h3>'+
          '<button onclick="closeEditEncounterModal()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>'+
        '</div>'+ 
        '<form id="edit-encounter-form" class="p-6 space-y-4">'+
          '<div class="grid grid-cols-2 gap-4">'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">SpO₂ (%)</label><input type="number" id="edit-spo2" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="95-100"></div>'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">FC (bpm)</label><input type="number" id="edit-hr" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="60-100"></div>'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">FR (ipm)</label><input type="number" id="edit-rr" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="12-20"></div>'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">PA Sistólica</label><input type="number" id="edit-bps" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="120"></div>'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">PA Diastólica</label><input type="number" id="edit-bpd" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="80"></div>'+
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">Temp (°C)</label><input type="number" id="edit-temp" step="0.1" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="36.5"></div>'+
          '</div>'+
          '<div class="space-y-2">'+
            '<label class="block text-sm font-medium text-gray-700 mb-1">Adicionar nota SOAP (opcional)</label>'+
            '<textarea id="edit-soap" rows="3" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="Observações adicionais..."></textarea>'+
          '</div>'+
          '<div class="flex justify-end gap-2 pt-4 border-t">'+
            '<button type="button" onclick="closeEditEncounterModal()" class="px-4 py-2 border rounded">Cancelar</button>'+
            '<button type="submit" class="btn-primary px-6 py-2"><i class="fas fa-save mr-2"></i>Salvar alterações</button>'+
          '</div>'+
        '</form>'+ 
      '</div>'+ 
    '</div>';
  var w=document.createElement('div'); w.id='edit-encounter-wrapper'; w.innerHTML=html; document.body.appendChild(w);
  var f=document.getElementById('edit-encounter-form');
  if(f){ f.addEventListener('submit', function(e){ e.preventDefault(); submitEditEncounter(encounterId); }); }
}

function closeEditEncounterModal(){ var w=document.getElementById('edit-encounter-wrapper'); if(w) w.remove(); }

function submitEditEncounter(encounterId){
  // Registra vitais se houver
  var spo2=document.getElementById('edit-spo2').value,
      hr=document.getElementById('edit-hr').value,
      rr=document.getElementById('edit-rr').value,
      bps=document.getElementById('edit-bps').value,
      bpd=document.getElementById('edit-bpd').value,
      temp=document.getElementById('edit-temp').value,
      soap=document.getElementById('edit-soap').value.trim();

  var doVitals = (spo2||hr||rr||bps||bpd||temp);
  var doNote = !!soap;
  showLoading();

  function finish(){ hideLoading(); showSuccess('Atendimento atualizado'); closeEditEncounterModal(); loadPatientEncounters(); }
  function fail(err){ hideLoading(); showError('Erro ao atualizar atendimento: '+((err&&err.message)||err||'')); }

  // Encadeia as duas operações conforme necessário
  try{
    if(doVitals){
      var data={ encounter_id:encounterId, spo2:spo2, hr:hr, rr:rr, bp_sys:bps, bp_dia:bpd, temp:temp };
      google.script.run.withSuccessHandler(function(){
        if(doNote){
          google.script.run.withSuccessHandler(finish).withFailureHandler(fail).addSessionNote({ encounter_id:encounterId, subjective:soap, objective:'', assessment:'', plan:'' });
        } else { finish(); }
      }).withFailureHandler(fail).recordVitals(data);
    } else if(doNote){
      google.script.run.withSuccessHandler(finish).withFailureHandler(fail).addSessionNote({ encounter_id:encounterId, subjective:soap, objective:'', assessment:'', plan:'' });
    } else {
      // nada a salvar
      finish();
    }
  }catch(e){ fail(e); }
}

// =============================================================================
// Relatórios (Docs-only)
// =============================================================================
function selectReportType(type){ var c=document.getElementById('report-form-container'); if(c) c.classList.remove('hidden'); var t=document.getElementById('report-type'); if(t) t.value=type; loadPatientsForReport(); }
function cancelReportSelection(){ var c=document.getElementById('report-form-container'); if(c) c.classList.add('hidden'); var f=document.getElementById('report-generation-form'); if(f) f.reset(); }
function loadPatientsForReport(){ var s=document.getElementById('report-patient-select'); if(!s) return; if(INITIAL_PATIENTS.length){ populateReportPatientSelect(INITIAL_PATIENTS); return; } google.script.run.withSuccessHandler(function(p){ populateReportPatientSelect(p||[]); }).withFailureHandler(function(){ s.innerHTML='<option value=\"\">Erro ao carregar pacientes</option>'; }).getFrontendPatients(); }
function populateReportPatientSelect(patients){ var s=document.getElementById('report-patient-select'); if(!s) return; var h='<option value=\"\">Selecione um paciente...</option>'; patients.forEach(function(p){ h+='<option value=\"'+p.id+'\">'+escapeHtml(p.full_name)+' ('+calculateAge(p.birth_date)+' anos)</option>'; }); s.innerHTML=h; }
function handleReportGenerationUpdated(e){ e.preventDefault(); var pid=document.getElementById('report-patient-select').value, type=document.getElementById('report-type').value; if(!pid){ showError('Selecione um paciente'); return; } var params={ patient_id:pid, type:type, format:'docs' }; generatePDFReportUpdated(params); }
document.addEventListener('DOMContentLoaded', function(){ var f=document.getElementById('report-generation-form'); if(f) f.addEventListener('submit', handleReportGenerationUpdated); });
function generatePDFReportUpdated(params){ showLoading(); var __pop=null; try{__pop=window.open('','_blank');}catch(e){} google.script.run.withSuccessHandler(function(res){ hideLoading(); if(res&&res.success&&res.url){ try{ if(__pop){ __pop.location=res.url; } else { window.open(res.url,'_blank'); } }catch(_){ window.open(res.url,'_blank'); } addReportToHistory({name:res.file_name,url:res.url,date:new Date().toISOString()}); } else { if(__pop){ try{__pop.close();}catch(_){}} showError('Erro ao gerar documento'); } }).withFailureHandler(function(err){ hideLoading(); if(__pop){ try{__pop.close();}catch(_){}} showError('Erro ao gerar documento: '+(err.message||err)); }).generateDocsReport(params); }
function addReportToHistory(r){ var h=document.getElementById('reports-history'); if(!h) return; var item='<div class=\"bg-white border rounded p-3 flex justify-between items-center\"><div><p class=\"font-medium text-gray-800\">'+escapeHtml(r.name)+'</p><p class=\"text-xs text-gray-500\">'+formatDateTime(r.date)+'</p></div><a href=\"'+r.url+'\" target=\"_blank\" class=\"text-blue-600 hover:text-blue-800 text-sm\"><i class=\"fas fa-external-link-alt mr-1\"></i>Abrir</a></div>'; if(h.querySelector('p.italic')) h.innerHTML=''; h.insertAdjacentHTML('afterbegin', item); }

</script><script>
// ==================== Overrides: Pacientes (modal completo) ====================
function showNewPatientModal() {
  var modal = document.getElementById('patient-modal');
  if (!modal) { createPatientModal(); modal = document.getElementById('patient-modal'); }
  var form = document.getElementById('patient-form'); if (form) form.reset();
  var titleEl = document.getElementById('patient-modal-title'); if (titleEl) titleEl.textContent = 'Novo Paciente';
  var idEl = document.getElementById('patient-id'); if (idEl) idEl.value = '';
  modal.classList.remove('hidden');
}
function editPatient(id) {
  var patient = (INITIAL_PATIENTS||[]).find(function(p){ return p.id === id; });
  if (!patient) { showError('Paciente não encontrado'); return; }
  var modal = document.getElementById('patient-modal'); if (!modal) { createPatientModal(); modal = document.getElementById('patient-modal'); }
  var titleEl = document.getElementById('patient-modal-title'); if (titleEl) titleEl.textContent = 'Editar Paciente';
  document.getElementById('patient-id').value = patient.id;
  document.getElementById('full_name').value = patient.full_name || '';
  document.getElementById('birth_date').value = patient.birth_date || '';
  document.getElementById('sex').value = patient.sex || '';
  document.getElementById('document_id').value = patient.document_id || '';
  document.getElementById('neonatal_mother_id').value = patient.neonatal_mother_id || '';
  modal.classList.remove('hidden');
}
function createPatientModal() {
  var modalHtml = "\
    <div id=\"patient-modal\" class=\"hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\
      <div class=\"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto\">\
        <div class=\"bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center\">\
          <h3 id=\"patient-modal-title\" class=\"text-xl font-bold\">Novo Paciente</h3>\
          <button onclick=\"closePatientModal()\" class=\"text-white hover:text-gray-200\"><i class=\"fas fa-times text-xl\"></i></button>\
        </div>\
        <form id=\"patient-form\" class=\"p-6 space-y-4\">\
          <input type=\"hidden\" id=\"patient-id\" />\
          <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\
            <div class=\"md:col-span-2\">\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Nome Completo <span class=\"text-red-500\">*</span></label>\
              <input type=\"text\" id=\"full_name\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"Nome completo do paciente\" />\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Data de Nascimento <span class=\"text-red-500\">*</span></label>\
              <input type=\"date\" id=\"birth_date\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" />\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Sexo <span class=\"text-red-500\">*</span></label>\
              <select id=\"sex\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\"><option value=\"\">Selecione...</option><option value=\"M\">Masculino</option><option value=\"F\">Feminino</option></select>\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">CPF <span class=\"text-red-500\">*</span></label>\
              <input type=\"text\" id=\"document_id\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"000.000.000-00\" maxlength=\"14\" />\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">ID Mãe (Neonatal)</label>\
              <input type=\"text\" id=\"neonatal_mother_id\" class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"Opcional\" />\
            </div>\
          </div>\
          <div class=\"flex justify-end space-x-3 pt-4 border-t\">\
            <button type=\"button\" onclick=\"closePatientModal()\" class=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50\">Cancelar</button>\
            <button type=\"submit\" class=\"btn-primary px-6 py-2\"><i class=\"fas fa-save mr-2\"></i>Salvar</button>\
          </div>\
        </form>\
      </div>\
    </div>";
  var div = document.createElement('div'); div.innerHTML = modalHtml; document.body.appendChild(div);
  var form = document.getElementById('patient-form'); if (form) form.addEventListener('submit', handlePatientSubmit);
  var cpf = document.getElementById('document_id'); if (cpf) cpf.addEventListener('input', function(e){ var v=e.target.value.replace(/\D/g,''); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2'); e.target.value=v; });
}
function closePatientModal(){ var m=document.getElementById('patient-modal'); if(m) m.classList.add('hidden'); }
function handlePatientSubmit(e){ e.preventDefault(); var id=document.getElementById('patient-id').value; var data={ full_name:document.getElementById('full_name').value.trim(), birth_date:document.getElementById('birth_date').value, sex:document.getElementById('sex').value, document_id:document.getElementById('document_id').value.replace(/\D/g,''), neonatal_mother_id:document.getElementById('neonatal_mother_id').value.trim() }; showLoading(); if(id){ google.script.run.withSuccessHandler(function(ok){ hideLoading(); if(ok){ showSuccess('Paciente atualizado com sucesso!'); closePatientModal(); var idx=INITIAL_PATIENTS.findIndex(function(p){return p.id===id;}); if(idx>-1) INITIAL_PATIENTS[idx]=Object.assign(INITIAL_PATIENTS[idx], data); loadPatients(); } else showError('Erro ao atualizar paciente'); }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao atualizar paciente: '+(err.message||err)); }).updatePatient(id,data); } else { google.script.run.withSuccessHandler(function(p){ hideLoading(); if(p&&p.id){ showSuccess('Paciente cadastrado com sucesso!'); closePatientModal(); INITIAL_PATIENTS.push(p); loadPatients(); } else showError('Erro ao criar paciente'); }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao cadastrar paciente: '+(err.message||err)); }).createPatient(data); } }

// ==================== Overrides: Atendimento (modal completo) ====================
function showEncounterModal(){ var modal=document.getElementById('encounter-modal'); if(!modal){ createEncounterModal(); modal=document.getElementById('encounter-modal'); } var n=document.getElementById('encounter-patient-name'); if(n) n.textContent=currentPatient.full_name; var info=document.getElementById('encounter-patient-info'); if(info) info.textContent = calculateAge(currentPatient.birth_date)+' anos • '+(currentPatient.sex||'-')+' • CPF: '+(currentPatient.document_id||''); var form=document.getElementById('encounter-form'); if(form) form.reset(); try{ loadProfessionalsForEncounter(); }catch(e){} modal.classList.remove('hidden'); }
function createEncounterModal(){ var h="\
  <div id=\"encounter-modal\" class=\"hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto\">\
    <div class=\"bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto\">\
      <div class=\"bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10\">\
        <div><h3 class=\"text-xl font-bold\">Novo Atendimento</h3><p class=\"text-sm text-blue-100\"><span id=\"encounter-patient-name\"></span> • <span id=\"encounter-patient-info\"></span></p></div>\
        <button onclick=\"closeEncounterModal()\" class=\"text-white hover:text-gray-200\"><i class=\"fas fa-times text-xl\"></i></button>\
      </div>\
      <form id=\"encounter-form\" class=\"p-6 space-y-6\">\
        <div class=\"border-b pb-4\">\
          <h4 class=\"text-lg font-bold mb-3 text-gray-700\"><i class=\"fas fa-info-circle mr-2 text-blue-600\"></i>Informações do Atendimento</h4>\
          <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\
            <div class=\"md:col-span-2\">\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Profissional <span class=\"text-red-500\">*</span> <button type=\"button\" onclick=\"showProfessionalModalFromDashboard()\" class=\"text-xs text-blue-200 underline ml-2\">Cadastrar</button></label>\
              <select id=\"encounter-professional\" required class=\"form-input w-full px-3 py-2 border rounded-lg\"><option value=\"\">Carregando profissionais...</option></select>\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Local <span class=\"text-red-500\">*</span></label>\
              <select id=\"encounter-location\" required class=\"form-input w-full px-3 py-2 border rounded-lg\"><option value=\"\">Selecione...</option><option value=\"AMBULATORIO\">Ambulatório</option><option value=\"LEITO\">Leito</option><option value=\"UTI\">UTI</option><option value=\"EMERGENCIA\">Emergência</option></select>\
            </div>\
            <div>\
              <label class=\"block text-sm font-medium text-gray-700 mb-1\">Tipo <span class=\"text-red-500\">*</span></label>\
              <select id=\"encounter-type\" required class=\"form-input w-full px-3 py-2 border rounded-lg\"><option value=\"\">Selecione...</option><option value=\"AVALIACAO\">Avaliação Inicial</option><option value=\"REAVALIACAO\">Reavaliação</option><option value=\"TRATAMENTO\">Tratamento</option><option value=\"ALTA\">Alta</option></select>\
            </div>\
          </div>\
        </div>\
        <div class=\"border-b pb-4\">\
          <h4 class=\"text-lg font-bold mb-3 text-gray-700\"><i class=\"fas fa-heartbeat mr-2 text-red-600\"></i>Sinais Vitais</h4>\
          <div class=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">SpO₂ (%)</label><input type=\"number\" id=\"vitals-spo2\" min=\"0\" max=\"100\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"95-100\"/></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">FC (bpm)</label><input type=\"number\" id=\"vitals-hr\" min=\"0\" max=\"300\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"60-100\"/></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">FR (ipm)</label><input type=\"number\" id=\"vitals-rr\" min=\"0\" max=\"100\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"12-20\"/></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">PA Sistólica</label><input type=\"number\" id=\"vitals-bp-sys\" min=\"0\" max=\"300\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"120\"/></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">PA Diastólica</label><input type=\"number\" id=\"vitals-bp-dia\" min=\"0\" max=\"200\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"80\"/></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">Temp (°C)</label><input type=\"number\" id=\"vitals-temp\" min=\"30\" max=\"45\" step=\"0.1\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"36.5\"/></div>\
          </div>\
        </div>\
        <div class=\"border-b pb-4\">\
          <h4 class=\"text-lg font-bold mb-3 text-gray-700\"><i class=\"fas fa-file-medical mr-2 text-green-600\"></i>Evolução SOAP</h4>\
          <div class=\"space-y-3\">\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\"><span class=\"bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold mr-2\">S</span>Subjetivo</label><textarea id=\"soap-subjective\" rows=\"2\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"O que o paciente relata?\"></textarea></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\"><span class=\"bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold mr-2\">O</span>Objetivo</label><textarea id=\"soap-objective\" rows=\"2\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"O que você observou?\"></textarea></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\"><span class=\"bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold mr-2\">A</span>Avaliação</label><textarea id=\"soap-assessment\" rows=\"2\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"Sua interpretação clínica\"></textarea></div>\
            <div><label class=\"block text-sm font-medium text-gray-700 mb-1\"><span class=\"bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs font-bold mr-2\">P</span>Plano</label><textarea id=\"soap-plan\" rows=\"2\" class=\"form-input w-full px-3 py-2 border rounded-lg\" placeholder=\"Condutas\"></textarea></div>\
          </div>\
        </div>\
        <div class=\"flex justify-end space-x-3 pt-4\"><button type=\"button\" onclick=\"closeEncounterModal()\" class=\"px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50\">Cancelar</button><button type=\"submit\" class=\"btn-primary px-6 py-2\"><i class=\"fas fa-save mr-2\"></i>Salvar Atendimento</button></div>\
      </form>\
    </div>\
  </div>"; var d=document.createElement('div'); d.innerHTML=h; document.body.appendChild(d); document.getElementById('encounter-form').addEventListener('submit', handleEncounterSubmit); }
function closeEncounterModal(){ var m=document.getElementById('encounter-modal'); if(m) m.classList.add('hidden'); }
function handleEncounterSubmit(e){ e.preventDefault(); if(!currentPatient){ showError('Nenhum paciente selecionado'); return; } var prof=document.getElementById('encounter-professional').value; if(!prof){ showError('Selecione o profissional do atendimento'); return; } showLoading(); var encounterData={ patient_id: currentPatient.id, professional_id: prof, location: document.getElementById('encounter-location').value, type: document.getElementById('encounter-type').value }; google.script.run.withSuccessHandler(function(enc){ currentEncounter=enc; saveVitals(enc.id); saveSOAP(enc.id); closeEncounterAndFinish(enc.id); }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao iniciar atendimento: '+(err.message||err)); }).openEncounter(encounterData); }
function saveVitals(encId){ var spo2=document.getElementById('vitals-spo2').value, hr=document.getElementById('vitals-hr').value, rr=document.getElementById('vitals-rr').value, bps=document.getElementById('vitals-bp-sys').value, bpd=document.getElementById('vitals-bp-dia').value, temp=document.getElementById('vitals-temp').value; if(!spo2&&!hr&&!rr&&!bps&&!bpd&&!temp) return; var data={ encounter_id:encId, spo2:spo2, hr:hr, rr:rr, bp_sys:bps, bp_dia:bpd, temp:temp }; google.script.run.withSuccessHandler(function(){}).withFailureHandler(function(e){ console.error(e); }).recordVitals(data); }
function saveSOAP(encId){ var s=document.getElementById('soap-subjective').value.trim(), o=document.getElementById('soap-objective').value.trim(), a=document.getElementById('soap-assessment').value.trim(), p=document.getElementById('soap-plan').value.trim(); if(!s&&!o&&!a&&!p) return; var data={ encounter_id:encId, subjective:s, objective:o, assessment:a, plan:p }; google.script.run.withSuccessHandler(function(){}).withFailureHandler(function(e){ console.error(e); }).addSessionNote(data); }
function closeEncounterAndFinish(encId){ google.script.run.withSuccessHandler(function(ok){ hideLoading(); showSuccess('Atendimento registrado com sucesso!'); closeEncounterModal(); currentEncounter=null; loadDashboardStats(); }).withFailureHandler(function(err){ hideLoading(); showError('Atendimento salvo, mas erro ao finalizar: '+(err.message||err)); closeEncounterModal(); }).closeEncounter(encId); }

// ==================== Overrides: Detalhes do atendimento ====================
function viewEncounterDetails(encounterId){ showLoading(); google.script.run.withSuccessHandler(function(resp){ hideLoading(); if(resp&&resp.data){ showEncounterDetailsModal(resp.data); } else { tryDirectMethod(encounterId); } }).withFailureHandler(function(){ hideLoading(); tryDirectMethod(encounterId); }).handleApiGet({ path: '/api/encounters/details', id: encounterId }); }
function tryDirectMethod(encounterId){ showLoading(); google.script.run.withSuccessHandler(function(details){ hideLoading(); if(details) showEncounterDetailsModal(details); else tryLocalFallback(encounterId); }).withFailureHandler(function(){ hideLoading(); tryLocalFallback(encounterId); }).getEncounterDetails(encounterId); }
function tryLocalFallback(encounterId){ var enc=(window.ENCOUNTERS_CACHE_BY_ID||{})[encounterId]; if(!enc){ showError('Atendimento não encontrado'); return; } var patient=(INITIAL_PATIENTS||[]).find(function(p){return p.id===enc.patient_id;})||{}; var data={ encounter:{ id:enc.id, patient_id:enc.patient_id, started_at:enc.started_at, ended_at:enc.ended_at, location:enc.location, type:enc.type }, patient:patient, professional:{ full_name:enc.professional_name||'N/A', crefito:enc.professional_crefito||'' }, notes:enc.notes||[], vitals:enc.vitals||[], assessments:enc.assessments||[], procedures:enc.procedures||[] }; showEncounterDetailsModal(data); }
function showEncounterDetailsModal(data){ var m=document.getElementById('encounter-details-modal'); if(!m){ createEncounterDetailsModal(); m=document.getElementById('encounter-details-modal'); } fillEncounterDetails(data); m.classList.remove('hidden'); }
function createEncounterDetailsModal(){ var h="\
  <div id=\"encounter-details-modal\" class=\"hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto\">\
    <div class=\"bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto\">\
      <div class=\"bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10\">\
        <div><h3 class=\"text-xl font-bold\">Detalhes do Atendimento</h3><p id=\"encounter-detail-subtitle\" class=\"text-sm text-blue-100\"></p></div>\
        <button onclick=\"closeEncounterDetailsModal()\" class=\"text-white hover:text-gray-200\"><i class=\"fas fa-times text-xl\"></i></button>\
      </div>\
      <div id=\"encounter-detail-content\" class=\"p-6\"></div>\
    </div>\
  </div>"; var d=document.createElement('div'); d.innerHTML=h; document.body.appendChild(d); }
function fillEncounterDetails(data){ var sub=document.getElementById('encounter-detail-subtitle'), c=document.getElementById('encounter-detail-content'); if(!data||!data.encounter){ if(c) c.innerHTML='<p class="text-red-500 text-center py-8">Erro ao carregar detalhes do atendimento</p>'; return; } var enc=data.encounter, patient=data.patient||{}, professional=data.professional||{}, notes=data.notes||[], vitals=data.vitals||[], assessments=data.assessments||[], procedures=data.procedures||[]; if(sub) sub.textContent=(patient.full_name||'Paciente')+' • '+formatDateTime(enc.started_at); var h=''; h+='<div class="mb-6 border-b pb-4"><h4 class="text-lg font-bold mb-3 text-gray-700"><i class="fas fa-info-circle mr-2 text-blue-600"></i>Informações do Atendimento</h4><div class="grid grid-cols-2 gap-4 text-sm"><div><span class="text-gray-500">Profissional:</span> <span class="font-medium">'+escapeHtml(professional.full_name||'N/A')+'</span></div><div><span class="text-gray-500">CREFITO:</span> <span class="font-medium">'+escapeHtml(professional.crefito||'-')+'</span></div><div><span class="text-gray-500">Local:</span> <span class="font-medium">'+escapeHtml(enc.location||'-')+'</span></div><div><span class="text-gray-500">Tipo:</span> <span class="font-medium">'+escapeHtml(enc.type||'-')+'</span></div><div><span class="text-gray-500">Início:</span> <span class="font-medium">'+formatDateTime(enc.started_at)+'</span></div><div><span class="text-gray-500">Fim:</span> <span class="font-medium">'+(enc.ended_at?formatDateTime(enc.ended_at):'Em andamento')+'</span></div></div></div>'; if(vitals.length>0){ h+='<div class="mb-6 border-b pb-4"><h4 class="text-lg font-bold mb-3 text-gray-700"><i class="fas fa-heartbeat mr-2 text-red-600"></i>Sinais Vitais</h4>'; vitals.forEach(function(v){ h+='<div class="bg-gray-50 p-3 rounded mb-2"><p class="text-xs text-gray-500 mb-2">'+formatDateTime(v.recorded_at)+'</p><div class="grid grid-cols-3 md:grid-cols-6 gap-3 text-sm">'+(v.spo2?'<div><span class="text-gray-600">SpO₂:</span> <span class="font-bold">'+v.spo2+'%</span></div>':'')+(v.hr?'<div><span class="text-gray-600">FC:</span> <span class="font-bold">'+v.hr+' bpm</span></div>':'')+(v.rr?'<div><span class="text-gray-600">FR:</span> <span class="font-bold">'+v.rr+' ipm</span></div>':'')+((v.bp_sys&&v.bp_dia)?'<div><span class="text-gray-600">PA:</span> <span class="font-bold">'+v.bp_sys+'/'+v.bp_dia+' mmHg</span></div>':'')+(v.temp?'<div><span class="text-gray-600">Temp:</span> <span class="font-bold">'+v.temp+'°C</span></div>':'')+'</div></div>'; }); h+='</div>'; }
 if(notes.length>0){ h+='<div class="mb-6 border-b pb-4"><h4 class="text-lg font-bold mb-3 text-gray-700"><i class="fas fa-file-medical mr-2 text-green-600"></i>Evolução SOAP</h4>'; notes.forEach(function(n){ h+='<div class="bg-gray-50 p-4 rounded mb-3"><p class="text-xs text-gray-500 mb-3">'+formatDateTime(n.recorded_at)+'</p>'+(n.subjective?'<div class="mb-3"><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold mr-2">S</span><span class="text-sm text-gray-700">'+escapeHtml(n.subjective)+'</span></div>':'')+(n.objective?'<div class="mb-3"><span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold mr-2">O</span><span class="text-sm text-gray-700">'+escapeHtml(n.objective)+'</span></div>':'')+(n.assessment?'<div class="mb-3"><span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold mr-2">A</span><span class="text-sm text-gray-700">'+escapeHtml(n.assessment)+'</span></div>':'')+(n.plan?'<div><span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs font-bold mr-2">P</span><span class="text-sm text-gray-700">'+escapeHtml(n.plan)+'</span></div>':'')+'</div>'; }); h+='</div>'; }
 if(assessments.length>0){ h+='<div class="mb-6 border-b pb-4"><h4 class="text-lg font-bold mb-3 text-gray-700"><i class="fas fa-clipboard-check mr-2 text-purple-600"></i>Avaliações</h4>'; assessments.forEach(function(a){ h+='<div class="bg-gray-50 p-3 rounded mb-2"><div class="flex justify-between items-start mb-2"><span class="font-bold text-gray-700">'+escapeHtml(a.tool||'')+'</span><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-bold">Score: '+(a.score||0)+'</span></div><p class="text-xs text-gray-500">'+formatDateTime(a.recorded_at)+'</p></div>'; }); h+='</div>'; }
 if(procedures.length>0){ h+='<div class="mb-6"><h4 class="text-lg font-bold mb-3 text-gray-700"><i class="fas fa-tasks mr-2 text-orange-600"></i>Procedimentos</h4>'; procedures.forEach(function(p){ h+='<div class="bg-gray-50 p-3 rounded mb-2"><div class="flex justify-between items-start"><div><span class="font-medium text-gray-700">'+escapeHtml(p.description||'Sem descrição')+'</span><p class="text-xs text-gray-500 mt-1">'+formatDateTime(p.recorded_at)+'</p></div>'+(p.code?('<span class="text-xs bg-gray-200 px-2 py-1 rounded">'+escapeHtml(p.code)+'</span>'):'')+'</div></div>'; }); h+='</div>'; }
 if(vitals.length===0 && notes.length===0 && assessments.length===0 && procedures.length===0){ h+='<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-6xl mb-4"></i><p class="text-lg">Nenhum dado clínico registrado</p></div>'; }
 c.innerHTML = h;
}
function closeEncounterDetailsModal(){ var m=document.getElementById('encounter-details-modal'); if(m) m.classList.add('hidden'); }
</script>
<script>
// ==================== Overrides: Profissional (dashboard) ====================
function showProfessionalModalFromDashboard() {
  var modal = document.getElementById('professional-modal-dashboard');
  if (!modal) { createProfessionalModalDashboard(); modal = document.getElementById('professional-modal-dashboard'); }
  var form = document.getElementById('professional-form-dashboard'); if (form) form.reset();
  modal.classList.remove('hidden');
}
function closeProfessionalModalDashboard(){ var m=document.getElementById('professional-modal-dashboard'); if(m) m.classList.add('hidden'); }
function createProfessionalModalDashboard(){ var html="\
  <div id=\"professional-modal-dashboard\" class=\"hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\
    <div class=\"bg-white rounded-lg shadow-xl max-w-xl w-full mx-4\">\
      <div class=\"bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center\">\
        <h3 class=\"text-xl font-bold\"><i class=\"fas fa-user-md mr-2\"></i>Cadastrar Profissional</h3>\
        <button onclick=\"closeProfessionalModalDashboard()\" class=\"text-white hover:text-gray-200\"><i class=\"fas fa-times text-xl\"></i></button>\
      </div>\
      <form id=\"professional-form-dashboard\" class=\"p-6 space-y-4\">\
        <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">Nome Completo <span class=\"text-red-500\">*</span></label><input type=\"text\" id=\"prof_full_name_dash\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"Nome do profissional\"/></div>\
        <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">Email <span class=\"text-red-500\">*</span></label><input type=\"email\" id=\"prof_email_dash\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"email@exemplo.com\"/></div>\
        <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">CREFITO</label><input type=\"text\" id=\"prof_crefito_dash\" class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\" placeholder=\"Opcional\"/></div>\
        <div><label class=\"block text-sm font-medium text-gray-700 mb-1\">Função <span class=\"text-red-500\">*</span></label><select id=\"prof_role_dash\" required class=\"form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500\"><option value=\"\">Selecione...</option><option value=\"FISIO\">Fisioterapeuta</option><option value=\"COORD\">Coordenador</option></select></div>\
        <div class=\"flex justify-end space-x-3 pt-4 border-t\"><button type=\"button\" onclick=\"closeProfessionalModalDashboard()\" class=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50\">Cancelar</button><button type=\"submit\" class=\"btn-primary px-6 py-2\"><i class=\"fas fa-save mr-2\"></i>Cadastrar</button></div>\
      </form>\
    </div>\
  </div>"; var w=document.createElement('div'); w.innerHTML=html; document.body.appendChild(w); var f=document.getElementById('professional-form-dashboard'); if(f) f.addEventListener('submit', handleProfessionalSubmitDashboard); }
function handleProfessionalSubmitDashboard(e){ e.preventDefault(); var data={ full_name:document.getElementById('prof_full_name_dash').value.trim(), email:document.getElementById('prof_email_dash').value.trim(), crefito:document.getElementById('prof_crefito_dash').value.trim(), role:document.getElementById('prof_role_dash').value, status:'ACTIVE' }; if(!data.full_name||!data.email||!data.role){ showError('Preencha todos os campos obrigatórios'); return; } showLoading(); google.script.run.withSuccessHandler(function(resp){ hideLoading(); if(resp&&resp.success&&resp.data&&resp.data.id){ showSuccess('Profissional cadastrado com sucesso!'); closeProfessionalModalDashboard(); } else showError('Erro ao cadastrar profissional'); }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao cadastrar profissional: '+(err.message||err)); }).handleApiPost('/api/professionals', data); }

// ==================== Overrides: Status do paciente ====================
function changePatientStatus(id){ var p=(INITIAL_PATIENTS||[]).find(function(x){return x.id===id;}); if(!p){ showError('Paciente não encontrado'); return; } var html='\
  <div id=\"status-change-modal\" class=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\
    <div class=\"bg-white rounded-lg shadow-xl max-w-md w-full mx-4\">\
      <div class=\"bg-purple-600 text-white px-6 py-3 rounded-t-lg flex justify-between items-center\"><h3 class=\"text-lg font-bold\">Alterar Status do Paciente</h3><button onclick=\"closeStatusChangeModal()\" class=\"text-white hover:text-gray-200\"><i class=\"fas fa-times\"></i></button></div>\
      <form id=\"status-change-form\" class=\"p-6 space-y-4\">\
        <input type=\"hidden\" id=\"status-patient-id\" value=\"'+id+'\"/>\
        <div><label class=\"block text-sm font-medium text-gray-700 mb-2\">Novo Status</label><select id=\"new-status\" class=\"form-input w-full px-3 py-2 border rounded-lg\"><option value=\"ACTIVE\">Ativo</option><option value=\"INACTIVE\">Inativo</option><option value=\"DISCHARGED\">Alta</option><option value=\"TRANSFERRED\">Transferido</option><option value=\"DECEASED\">Falecido</option></select></div>\
        <div class=\"flex justify-end space-x-3 pt-2\"><button type=\"button\" onclick=\"closeStatusChangeModal()\" class=\"px-4 py-2 border rounded\">Cancelar</button><button type=\"submit\" class=\"btn-primary px-4 py-2\">Confirmar</button></div>\
      </form>\
    </div>\
  </div>'; var d=document.createElement('div'); d.id='status-change-wrapper'; d.innerHTML=html; document.body.appendChild(d); document.getElementById('new-status').value=p.status||'ACTIVE'; document.getElementById('status-change-form').addEventListener('submit', handleStatusChange); }
function closeStatusChangeModal(){ var w=document.getElementById('status-change-wrapper'); if(w) w.remove(); }
function handleStatusChange(e){ e.preventDefault(); var id=document.getElementById('status-patient-id').value, st=document.getElementById('new-status').value; showLoading(); google.script.run.withSuccessHandler(function(ok){ hideLoading(); if(ok){ var p=(INITIAL_PATIENTS||[]).find(function(x){return x.id===id;}); if(p) p.status=st; showSuccess('Status atualizado'); closeStatusChangeModal(); loadPatients(); } else showError('Erro ao atualizar status'); }).withFailureHandler(function(err){ hideLoading(); showError('Erro ao atualizar status: '+(err.message||err)); }).updatePatient(id,{status:st}); }
</script>
<script>
// ==================== Agenda (semana + criação) ====================
var AGENDA_STATE = { startOfWeek: null, events: [] };

function __startOfWeek(d){ var x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); var day=x.getDay(); var diff=(day===0?-6:1)-day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
function __endOfWeek(monday){ var x=new Date(monday); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }

function loadAgendaTab(){ if(!AGENDA_STATE.startOfWeek){ AGENDA_STATE.startOfWeek=__startOfWeek(new Date()); } fetchAgendaAndRender(); }
function agendaPrevWeek(){ AGENDA_STATE.startOfWeek.setDate(AGENDA_STATE.startOfWeek.getDate()-7); fetchAgendaAndRender(); }
function agendaNextWeek(){ AGENDA_STATE.startOfWeek.setDate(AGENDA_STATE.startOfWeek.getDate()+7); fetchAgendaAndRender(); }
function agendaToday(){ AGENDA_STATE.startOfWeek=__startOfWeek(new Date()); fetchAgendaAndRender(); }

function fetchAgendaAndRender(){ var start=AGENDA_STATE.startOfWeek; var end=__endOfWeek(start); var rangeEl=document.getElementById('agenda-range'); if(rangeEl){ var fmt=function(d){ return ('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2); }; rangeEl.textContent = fmt(start)+' - '+fmt(end); }
  showLoading();
  google.script.run
    .withSuccessHandler(function(resp){ hideLoading(); var ev=(resp&&resp.data)||[]; AGENDA_STATE.events = Array.isArray(ev)?ev:[]; renderAgendaWeek(); })
    .withFailureHandler(function(err){ hideLoading(); showError('Erro ao carregar agenda: '+(err&&err.message||err||'')); renderAgendaWeek(); })
    .handleApiGet({ path: '/api/agenda', start: start.toISOString(), end: end.toISOString() });
}


function ensurePatientsLoaded(next){ if(Array.isArray(INITIAL_PATIENTS) && INITIAL_PATIENTS.length){ try{ return next(); }catch(_){} return; } showLoading(); google.script.run.withSuccessHandler(function(p){ hideLoading(); INITIAL_PATIENTS = Array.isArray(p)?p:[]; try{ next(); }catch(_){} }).withFailureHandler(function(){ hideLoading(); try{ next(); }catch(_){} }).getFrontendPatients(); }

function renderAppointmentModal(slotISO){ var w=document.createElement('div'); var startVal = slotISO || new Date().toISOString().slice(0,16); var endVal=(function(){ var d=new Date(startVal); d.setHours(d.getHours()+1); return d.toISOString().slice(0,16); })(); w.id='agenda-modal-wrapper'; w.innerHTML=''
  +'<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">'
  +  '<div class="bg-white rounded-lg shadow-xl w-full max-w-xl mx-4">'
  +    '<div class="bg-blue-600 text-white px-6 py-3 rounded-t-lg flex justify-between items-center">'
  +      '<h3 class="text-lg font-bold"><i class="fas fa-calendar-plus mr-2"></i>Novo Agendamento</h3>'
  +      '<button onclick="closeAgendaModal()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>'
  +    '</div>'
  +    '<form id="agenda-form" class="p-6 space-y-4">'
  +      '<div><label class="block text-sm font-medium text-gray-700 mb-1">Paciente</label><select id="agenda-patient" class="form-input w-full px-3 py-2 border rounded-lg"><option value="">Selecione...</option>'
  +        + (INITIAL_PATIENTS||[]).map(function(p){ return '<option value="'+p.id+'">'+escapeHtml(p.full_name)+'</option>'; }).join('')
  +      + '</select></div>'
  +      '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'
  +        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Início</label><input id="agenda-start" type="datetime-local" value="'+startVal.slice(0,16)+'" class="form-input w-full px-3 py-2 border rounded-lg"></div>'
  +        '<div><label class="block text-sm font-medium text-gray-700 mb-1">Fim</label><input id="agenda-end" type="datetime-local" value="'+endVal.slice(0,16)+'" class="form-input w-full px-3 py-2 border rounded-lg"></div>'
  +      '</div>'
  +      '<div><label class="block text-sm font-medium text-gray-700 mb-1">Título</label><input id="agenda-title" type="text" class="form-input w-full px-3 py-2 border rounded-lg" placeholder="Sessão de fisioterapia"></div>'
  +      '<div class="flex justify-end gap-2 pt-4 border-t">'
  +        '<button type="button" onclick="closeAgendaModal()" class="px-4 py-2 border rounded">Cancelar</button>'
  +        '<button type="submit" class="btn-primary px-6 py-2"><i class="fas fa-save mr-2"></i>Salvar</button>'
  +      '</div>'
  +    '</form>'
  +  '</div>'
  +'</div>';
  document.body.appendChild(w);
  var f=document.getElementById('agenda-form'); if(f){ f.addEventListener('submit', handleAgendaSubmit); }
}
function renderAgendaWeek(){ var container=document.getElementById('agenda-calendar'); if(!container) return; var monday=AGENDA_STATE.startOfWeek; var days=[]; for(var i=0;i<7;i++){ var d=new Date(monday); d.setDate(monday.getDate()+i); d.setHours(0,0,0,0); days.push(d); }
  var hours=[]; for(var h=8;h<=18;h++) hours.push(h);
  var weekDays=['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'];
  var html=''; html+='<div class="grid grid-cols-8 gap-2">'; html+='<div></div>'; for(var k=0;k<7;k++){ html+='<div class="text-center font-semibold">'+weekDays[k]+' '+('0'+days[k].getDate()).slice(-2)+'</div>'; } html+='</div>';
  hours.forEach(function(hh){ html+='<div class="grid grid-cols-8 gap-2 items-stretch">'; html+='<div class="text-right pr-2 text-sm text-gray-500">'+('0'+hh).slice(-2)+':00</div>'; for(var c=0;c<7;c++){ var cellDate=new Date(days[c]); cellDate.setHours(hh,0,0,0); var iso = cellDate.toISOString(); var cellEvents = (AGENDA_STATE.events||[]).filter(function(ev){ try{ var es=new Date(ev.start); return es.getFullYear()==cellDate.getFullYear() && es.getMonth()==cellDate.getMonth() && es.getDate()==cellDate.getDate() && es.getHours()==cellDate.getHours(); }catch(_){ return false; } }); var pills = cellEvents.map(function(ev){ var t=escapeHtml(ev.title||'Sessão'); return '<div class="text-xs bg-blue-100 text-blue-800 rounded px-1 py-0.5 truncate">'+t+'</div>'; }).join(''); html+='<div class="bg-white border rounded p-2 h-16 hover:bg-blue-50 cursor-pointer" data-slot="'+iso+'" onclick="openNewAppointmentModal(this.getAttribute(\'data-slot\'))">'+pills+'</div>'; } html+='</div>'; });
  container.innerHTML=html;
}

function openNewAppointmentModal(slotISO){ ensurePatientsLoaded(function(){ renderAppointmentModalImproved(slotISO); }); }
function closeAgendaModal(){ var w=document.getElementById('agenda-modal-wrapper'); if(w) w.remove(); }

function handleAgendaSubmit(e){ e.preventDefault(); var pid=document.getElementById('agenda-patient').value; var title=document.getElementById('agenda-title').value.trim(); var start=document.getElementById('agenda-start').value; var end=document.getElementById('agenda-end').value; if(!pid||!start||!end){ showError('Preencha paciente, Início e fim'); return; } showLoading();
  google.script.run
    .withSuccessHandler(function(resp){ hideLoading(); if(resp&&resp.success){ showSuccess('Agendamento salvo'); closeAgendaModal(); fetchAgendaAndRender(); } else { showError('Falha ao salvar agendamento'); } })
    .withFailureHandler(function(err){ hideLoading(); showError('Erro ao salvar agendamento: '+(err&&err.message||err||'')); })
    .handleApiPost('/api/agenda', { patient_id: pid, title: title, start: start, end: end });
}
</script>


<script>
function renderAppointmentModalImproved(slotISO){
  function fmtLocal(dt){ var p=function(n){return ('0'+n).slice(-2)}; return dt.getFullYear()+'-'+p(dt.getMonth()+1)+'-'+p(dt.getDate())+'T'+p(dt.getHours())+':'+p(dt.getMinutes()); }
  var startDate = slotISO ? new Date(slotISO) : new Date();
  var endDate = new Date(startDate.getTime() + 60*60000);
  var startVal = fmtLocal(startDate);
  var endVal = fmtLocal(endDate);
  var w=document.createElement('div');
  w.id='agenda-modal-wrapper';
  w.innerHTML=''
    +'<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">'
    +  '<div class="bg-white rounded-lg shadow-xl w-full max-w-xl mx-4">'
    +    '<div class="bg-blue-600 text-white px-6 py-3 rounded-t-lg flex justify-between items-center">'
    +      '<h3 class="text-lg font-bold"><i class="fas fa-calendar-plus mr-2"></i>Novo Agendamento</h3>'
    +      '<button onclick="closeAgendaModal()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>'
    +    '</div>'
    +    '<form id="agenda-form" class="p-6 space-y-5">'
    +      '<div>'
    +        '<label class="block text-sm font-medium text-gray-700 mb-1">Paciente <span class="text-red-500">*</span></label>'
    +        '<select id="agenda-patient" required autofocus class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">Selecione...</option>'
    +           (INITIAL_PATIENTS||[]).map(function(p){ return '<option value="'+p.id+'">'+escapeHtml(p.full_name)+' ('+calculateAge(p.birth_date)+' anos)</option>'; }).join('')
    +        + '</select>'
    +      '</div>'
    +      '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'
    +        '<div>'
    +          '<label class="block text-sm font-medium text-gray-700 mb-1">Início <span class="text-red-500">*</span></label>'
    +          '<input id="agenda-start" type="datetime-local" value="'+startVal+'" min="'+fmtLocal(new Date())+'" class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">'
    +        '</div>'
    +        '<div>'
    +          '<label class="block text-sm font-medium text-gray-700 mb-1">Fim <span class="text-red-500">*</span></label>'
    +          '<input id="agenda-end" type="datetime-local" value="'+endVal+'" min="'+startVal+'" class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">'
    +        '</div>'
    +      '</div>'
    +      '<div>'
    +        '<label class="block text-sm font-medium text-gray-700 mb-1">Título</label>'
    +        '<input id="agenda-title" type="text" class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Sessão de fisioterapia">'
    +      '</div>'
    +      '<div class="flex justify-end gap-2 pt-4 border-t">'
    +        '<button type="button" onclick="closeAgendaModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancelar</button>'
    +        '<button type="submit" class="btn-primary px-6 py-2"><i class="fas fa-save mr-2"></i>Salvar</button>'
    +      '</div>'
    +    '</form>'
    +  '</div>'
    +'</div>';
  document.body.appendChild(w);
  var f=document.getElementById('agenda-form'); if(f){ f.addEventListener('submit', handleAgendaSubmit); }
  var sel=document.getElementById('agenda-patient'); var title=document.getElementById('agenda-title'); var endEl=document.getElementById('agenda-end'); var startEl=document.getElementById('agenda-start');
  if(sel){ sel.addEventListener('change', function(){ if(title && !title.value){ var opt=sel.options[sel.selectedIndex]; if(opt){ title.value = 'Sessão com '+opt.text.replace(/\s*\(.*\)$/, ''); } } }); }
  if(startEl && endEl){ startEl.addEventListener('change', function(){ try{ var s=new Date(startEl.value); var e=new Date(s.getTime()+60*60000); endEl.value = (function(d){ var p=function(n){return ('0'+n).slice(-2)}; return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+'T'+p(d.getHours())+':'+p(d.getMinutes()); })(e); endEl.min = startEl.value; }catch(_){} }); }
}
</script>


