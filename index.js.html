<script>
/**
 * ============================================================================
 * SISTEMA FISIOTERAPIA - FRONTEND FINAL MERGE
 * Fonte base: vers√£o corrigida (nova)
 * Itens preservados/injetados: modais de detalhes, cache, fallback, modal profissional inline
 * ============================================================================
 */

// Vari√°veis globais
var currentUser = null;
var currentPatient = null;
var currentEncounter = null;
var INITIAL_PATIENTS = [];
var currentFilteredPatient = null; // [MERGE] mantido do antigo
if (!window.ENCOUNTERS_CACHE_BY_ID) {
  window.ENCOUNTERS_CACHE_BY_ID = {}; // [MERGE] cache local de atendimentos p/ fallback offline
}

// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Sistema iniciado');
  
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    console.error('‚ùå google.script.run n√£o dispon√≠vel');
    showError('Sistema n√£o inicializado. Acesse via URL do Web App.');
    return;
  }
  
  console.log('‚úÖ google.script.run dispon√≠vel');
  loadUser();
  
  // tenta carregar pacientes injetados no HTML pelo backend
  try {
    if (typeof PATIENTS_DATA !== 'undefined' && PATIENTS_DATA) {
      debugLog('‚úÖ Pacientes carregados do servidor', PATIENTS_DATA);
      INITIAL_PATIENTS = PATIENTS_DATA;
      updateDashboardStats(PATIENTS_DATA.length);
    }
  } catch (e) {
    debugLog('‚ö†Ô∏è Erro ao carregar pacientes do servidor:', e);
  }
});

// ============================================================================
// FUN√á√ïES DE DEBUG
// ============================================================================

function debugLog(message, data) {
  console.log(message, data);
  
  var debugDiv = document.getElementById('debug-output');
  if (!debugDiv) {
    debugDiv = document.createElement('div');
    debugDiv.id = 'debug-output';
    debugDiv.style.cssText = 'position:fixed;bottom:0;left:0;right:0;max-height:30vh;overflow:auto;background:#0b1215;color:#9fe29f;font:12px/1.4 monospace;padding:8px;z-index:50;border-top:1px solid #0f0;display:none;';
    document.body.appendChild(debugDiv);
  }
  
  var timestamp = new Date().toLocaleTimeString();
  var dataStr = '';
  if (data !== undefined) {
    try {
      dataStr = ' | ' + JSON.stringify(data, null, 2);
    } catch (e) {
      dataStr = ' | [Erro ao serializar]';
    }
  }
  
  debugDiv.innerHTML += '<div style="border-bottom: 1px solid #0f0; padding: 5px 0;">' +
    '<strong>' + timestamp + '</strong>: ' + message + dataStr + '</div>';
  debugDiv.scrollTop = debugDiv.scrollHeight;
}

function toggleDebug() {
  var debugDiv = document.getElementById('debug-output');
  if (debugDiv) {
    debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
  }
}

// ============================================================================
// USU√ÅRIO
// ============================================================================

function loadUser() {
  debugLog('üìÑ Carregando usu√°rio...');
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(user) {
      debugLog('‚úÖ Usu√°rio recebido', user);
      hideLoading();
      
      if (!user || !user.role) {
        showError('Acesso negado. Usu√°rio sem permiss√£o.');
        return;
      }
      
      currentUser = user;
      
      var nameEl = document.getElementById('user-name');
      var roleEl = document.getElementById('user-role');
      
      if (nameEl) nameEl.textContent = user.email || '';
      if (roleEl) roleEl.textContent = user.role || '';
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao carregar usu√°rio', error);
      hideLoading();
      showError('Erro ao carregar usu√°rio: ' + (error.message || error));
    })
    .handleApiGet({ path: '/api/user' });
}

// ============================================================================
// DASHBOARD
// ============================================================================

function updateDashboardStats(count) {
  var statEl = document.getElementById('stat-patients');
  if (statEl) {
    statEl.textContent = count;
  }
}

function loadDashboardStats() {
  debugLog('üìä Usando pacientes do cache');
  updateDashboardStats(INITIAL_PATIENTS.length);
}

// ============================================================================
// NAVEGA√á√ÉO DE ABAS
// ============================================================================

function showTab(tabName, event) {
  debugLog('üîÄ Mudando para aba: ' + tabName);
  
  var tabs = document.querySelectorAll('.tab-btn');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove('active');
  }
  
  var contents = document.querySelectorAll('.tab-content');
  for (var j = 0; j < contents.length; j++) {
    contents[j].classList.add('hidden');
  }
  
  if (event && event.target) {
    var btn = event.target.closest('.tab-btn');
    if (btn) btn.classList.add('active');
  }
  
  var tabElement = document.getElementById(tabName + '-tab');
  if (tabElement) {
    tabElement.classList.remove('hidden');
  }
  
  if (tabName === 'patients') {
    loadPatients();
  } else if (tabName === 'encounters') {
    loadEncounters();
  }
}

// ============================================================================
// PACIENTES - LISTAGEM / BUSCA / MODAL
// ============================================================================

function loadPatients() {
  debugLog('üìÑ Carregando pacientes...');
  
  // tenta usar cache primeiro
  if (INITIAL_PATIENTS.length > 0) {
    debugLog('‚úÖ Usando pacientes do cache (' + INITIAL_PATIENTS.length + ')');
    renderPatientsList(INITIAL_PATIENTS);
    return;
  }
  
  debugLog('‚ö†Ô∏è Cache vazio, tentando carregar via API...');
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(patients) {
      debugLog('‚úÖ Callback executado');
      hideLoading();
      
      if (patients && Array.isArray(patients)) {
        debugLog('‚úÖ Total recebido: ' + patients.length);
        INITIAL_PATIENTS = patients;
        renderPatientsList(patients);
      } else {
        debugLog('‚ö†Ô∏è Resposta inv√°lida');
        showError('Erro: Dados inv√°lidos do servidor');
        renderPatientsList([]);
      }
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro no callback', error);
      hideLoading();
      showError('Erro ao carregar: ' + (error.message || error));
      renderPatientsList([]);
    })
    .getFrontendPatients();
}

/**
 * ============================================================================
 * FRONTEND - Tradu√ß√£o de Status para Portugu√™s
 * ============================================================================
 */

// ‚úÖ MAPA DE TRADU√á√ÉO DE STATUS
var STATUS_MAP = {
  'ACTIVE': 'Ativo',
  'INACTIVE': 'Inativo',
  'DISCHARGED': 'Alta',
  'TRANSFERRED': 'Transferido',
  'DECEASED': 'Falecido'
};

// ‚úÖ CLASSES DE COR POR STATUS
var STATUS_CLASSES = {
  'ACTIVE': 'bg-green-100 text-green-800',
  'INACTIVE': 'bg-gray-100 text-gray-800',
  'DISCHARGED': 'bg-blue-100 text-blue-800',
  'TRANSFERRED': 'bg-yellow-100 text-yellow-800',
  'DECEASED': 'bg-red-100 text-red-800'
};

/**
 * Traduz status para portugu√™s
 */
function translateStatus(status) {
  if (!status) return 'Ativo';
  var upperStatus = String(status).trim().toUpperCase();
  return STATUS_MAP[upperStatus] || status;
}

/**
 * Retorna classe CSS para o status
 */
function getStatusClass(status) {
  if (!status) return STATUS_CLASSES['ACTIVE'];
  var upperStatus = String(status).trim().toUpperCase();
  return STATUS_CLASSES[upperStatus] || 'bg-gray-100 text-gray-800';
}

/**
 * Renderiza lista de pacientes (ATUALIZADA)
 */
function renderPatientsList(patients) {
  debugLog('üé® Renderizando lista', {
    type: typeof patients,
    is_array: Array.isArray(patients),
    length: patients ? patients.length : 0
  });
  
  var container = document.getElementById('patients-list');
  
  if (!container) {
    debugLog('‚ùå Container n√£o encontrado');
    showError('Erro: elemento patients-list n√£o existe');
    return;
  }
  
  if (!patients || !Array.isArray(patients)) {
    debugLog('‚ö†Ô∏è Dados inv√°lidos');
    container.innerHTML = '<p class="text-red-500 text-center py-8">Erro: dados inv√°lidos</p>';
    return;
  }
  
  if (patients.length === 0) {
    debugLog('‚ö†Ô∏è Lista vazia');
    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum paciente cadastrado</p>';
    return;
  }
  
  debugLog('‚úÖ Renderizando ' + patients.length + ' pacientes');
  
  var html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
  
  for (var i = 0; i < patients.length; i++) {
    var patient = patients[i];
    var age = calculateAge(patient.birth_date);
    
    // ‚úÖ TRADUZ STATUS PARA PORTUGU√äS
    var statusText = translateStatus(patient.status);
    var statusClass = getStatusClass(patient.status);
    
    html += '<div class="patient-card bg-white p-4 rounded-lg shadow cursor-pointer" onclick="viewPatient(\'' + patient.id + '\')">';
    html += '  <div class="flex items-start justify-between">';
    html += '    <div class="flex-1">';
    html += '      <h3 class="font-bold text-lg">' + escapeHtml(patient.full_name) + '</h3>';
    html += '      <p class="text-sm text-gray-600">' + age + ' anos ‚Ä¢ ' + (patient.sex || '-') + '</p>';
    html += '      <p class="text-xs text-gray-500 mt-1">CPF: ' + escapeHtml(String(patient.document_id || '')) + '</p>';
    html += '    </div>';
    
    // ‚úÖ BADGE DE STATUS EM PORTUGU√äS
    html += '    <span class="text-xs px-2 py-1 rounded font-medium ' + statusClass + '">' + statusText + '</span>';
    html += '  </div>';
    
    html += '  <div class="mt-3 flex space-x-2">';
    html += '    <button onclick="event.stopPropagation(); startEncounter(\'' + patient.id + '\')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">';
    html += '      <i class="fas fa-play mr-1"></i>Atender';
    html += '    </button>';
    html += '    <button onclick="event.stopPropagation(); editPatient(\'' + patient.id + '\')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">';
    html += '      <i class="fas fa-edit mr-1"></i>Editar';
    html += '    </button>';
    
    // ‚úÖ NOVO: BOT√ÉO PARA MUDAR STATUS
    html += '    <button onclick="event.stopPropagation(); changePatientStatus(\'' + patient.id + '\')" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200" title="Alterar Status">';
    html += '      <i class="fas fa-exchange-alt"></i>';
    html += '    </button>';
    
    html += '  </div>';
    html += '</div>';
  }
  
  html += '</div>';
  
  container.innerHTML = html;
  debugLog('‚úÖ Renderiza√ß√£o conclu√≠da');
}

/**
 * ‚úÖ NOVA FUN√á√ÉO: Alterar status do paciente
 */
function changePatientStatus(patientId) {
  debugLog('üîÑ Alterando status do paciente: ' + patientId);
  
  var patient = INITIAL_PATIENTS.find(function(p) { return p.id === patientId; });
  
  if (!patient) {
    showError('Paciente n√£o encontrado');
    return;
  }
  
  showStatusChangeModal(patient);
}

/**
 * ‚úÖ NOVA FUN√á√ÉO: Modal de mudan√ßa de status
 */
function showStatusChangeModal(patient) {
  var modal = document.getElementById('status-change-modal');
  
  if (!modal) {
    createStatusChangeModal();
    modal = document.getElementById('status-change-modal');
  }
  
  // Preenche informa√ß√µes do paciente
  document.getElementById('status-patient-name').textContent = patient.full_name;
  document.getElementById('status-patient-id').value = patient.id;
  
  // Seleciona status atual
  var currentStatus = patient.status || 'ACTIVE';
  document.getElementById('new-status').value = currentStatus;
  
  modal.classList.remove('hidden');
}

/**
 * ‚úÖ NOVA FUN√á√ÉO: Cria modal de mudan√ßa de status
 */
function createStatusChangeModal() {
  var modalHtml = `
    <div id="status-change-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="bg-purple-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
          <h3 class="text-xl font-bold">
            <i class="fas fa-exchange-alt mr-2"></i>Alterar Status do Paciente
          </h3>
          <button onclick="closeStatusChangeModal()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="status-change-form" class="p-6 space-y-4">
          <input type="hidden" id="status-patient-id" />
          
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-sm text-blue-800">
              <i class="fas fa-user mr-2"></i>
              <strong id="status-patient-name"></strong>
            </p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Novo Status <span class="text-red-500">*</span>
            </label>
            <select id="new-status" required 
                    class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
              <option value="ACTIVE">Ativo</option>
              <option value="INACTIVE">Inativo</option>
              <option value="DISCHARGED">Alta</option>
              <option value="TRANSFERRED">Transferido</option>
              <option value="DECEASED">Falecido</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Observa√ß√µes (opcional)
            </label>
            <textarea id="status-notes" rows="3"
                      class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" 
                      placeholder="Motivo da mudan√ßa de status..."></textarea>
          </div>
          
          <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
            <p class="text-sm text-yellow-800">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              Esta a√ß√£o ser√° registrada no hist√≥rico do paciente.
            </p>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button type="button" onclick="closeStatusChangeModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary px-6 py-2 bg-purple-600 hover:bg-purple-700">
              <i class="fas fa-check mr-2"></i>Confirmar Mudan√ßa
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  var div = document.createElement('div');
  div.innerHTML = modalHtml;
  document.body.appendChild(div);
  
  var form = document.getElementById('status-change-form');
  if (form) form.addEventListener('submit', handleStatusChange);
}

/**
 * ‚úÖ NOVA FUN√á√ÉO: Fecha modal de status
 */
function closeStatusChangeModal() {
  var modal = document.getElementById('status-change-modal');
  if (modal) modal.classList.add('hidden');
}

/**
 * ‚úÖ NOVA FUN√á√ÉO: Processa mudan√ßa de status
 */
function handleStatusChange(e) {
  e.preventDefault();
  
  var patientId = document.getElementById('status-patient-id').value;
  var newStatus = document.getElementById('new-status').value;
  var notes = document.getElementById('status-notes').value.trim();
  
  debugLog('üíæ Mudando status do paciente...', {
    patientId: patientId,
    newStatus: newStatus,
    notes: notes
  });
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(success) {
      debugLog('‚úÖ Status atualizado', success);
      hideLoading();
      
      if (success) {
        showSuccess('Status do paciente atualizado com sucesso!');
        closeStatusChangeModal();
        
        // Atualiza cache local
        var patient = INITIAL_PATIENTS.find(function(p) { return p.id === patientId; });
        if (patient) {
          patient.status = newStatus;
        }
        
        // Recarrega lista
        loadPatients();
        
        // Registra no log de auditoria (se houver observa√ß√µes)
        if (notes) {
          debugLog('üìù Registrando observa√ß√£o no hist√≥rico');
        }
      } else {
        showError('Erro ao atualizar status do paciente');
      }
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao atualizar status', error);
      hideLoading();
      showError('Erro ao atualizar status: ' + (error.message || error));
    })
    .updatePatient(patientId, { status: newStatus });
}

function searchPatients() {
  var searchEl = document.getElementById('patient-search');
  var query = searchEl ? searchEl.value : '';
  if (query.length < 2) {
    loadPatients();
    return;
  }
  
  debugLog('üîç Buscando: ' + query);
  
  var filtered = INITIAL_PATIENTS.filter(function(p) {
    var name = (p.full_name || '').toLowerCase();
    var doc = String(p.document_id || '');
    var q = query.toLowerCase();
    return name.indexOf(q) !== -1 || doc.indexOf(query) !== -1;
  });
  
  renderPatientsList(filtered);
}

// ============================================================================
// PACIENTE - MODAL NOVO / EDITAR
// ============================================================================

function showNewPatientModal() {
  debugLog('üÜï Abrindo modal de novo paciente');
  
  var modal = document.getElementById('patient-modal');
  if (!modal) {
    debugLog('‚ö†Ô∏è Modal n√£o encontrado, criando...');
    createPatientModal();
    modal = document.getElementById('patient-modal');
  }
  
  var form = document.getElementById('patient-form');
  if (form) form.reset();
  var titleEl = document.getElementById('patient-modal-title');
  if (titleEl) titleEl.textContent = 'Novo Paciente';
  var idEl = document.getElementById('patient-id');
  if (idEl) idEl.value = '';
  
  modal.classList.remove('hidden');
}

function editPatient(id) {
  debugLog('‚úèÔ∏è Editar paciente: ' + id);
  
  var patient = INITIAL_PATIENTS.find(function(p) { return p.id === id; });
  
  if (!patient) {
    showError('Paciente n√£o encontrado');
    return;
  }
  
  var modal = document.getElementById('patient-modal');
  if (!modal) {
    createPatientModal();
    modal = document.getElementById('patient-modal');
  }
  
  var titleEl = document.getElementById('patient-modal-title');
  if (titleEl) titleEl.textContent = 'Editar Paciente';
  
  document.getElementById('patient-id').value = patient.id;
  document.getElementById('full_name').value = patient.full_name || '';
  document.getElementById('birth_date').value = patient.birth_date || '';
  document.getElementById('sex').value = patient.sex || '';
  document.getElementById('document_id').value = patient.document_id || '';
  document.getElementById('neonatal_mother_id').value = patient.neonatal_mother_id || '';
  
  try {
    var allergies = patient.allergies_json ? JSON.parse(patient.allergies_json) : (patient.allergies || []);
    document.getElementById('allergies').value = Array.isArray(allergies) ? allergies.join(', ') : '';
  } catch (e) {
    document.getElementById('allergies').value = '';
  }
  
  try {
    var conditions = patient.conditions_json ? JSON.parse(patient.conditions_json) : (patient.conditions || []);
    document.getElementById('conditions').value = Array.isArray(conditions) ? conditions.join(', ') : '';
  } catch (e) {
    document.getElementById('conditions').value = '';
  }
  
  modal.classList.remove('hidden');
}

function createPatientModal() {
  var modalHtml = `
    <div id="patient-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
          <h3 id="patient-modal-title" class="text-xl font-bold">Novo Paciente</h3>
          <button onclick="closePatientModal()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="patient-form" class="p-6 space-y-4">
          <input type="hidden" id="patient-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Nome Completo <span class="text-red-500">*</span>
              </label>
              <input type="text" id="full_name" required 
                     class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                     placeholder="Nome completo do paciente" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Data de Nascimento <span class="text-red-500">*</span>
              </label>
              <input type="date" id="birth_date" required 
                     class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Sexo <span class="text-red-500">*</span>
              </label>
              <select id="sex" required 
                      class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Selecione...</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                CPF <span class="text-red-500">*</span>
              </label>
              <input type="text" id="document_id" required 
                     class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                     placeholder="000.000.000-00"
                     maxlength="14" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                ID M√£e (Neonatal)
              </label>
              <input type="text" id="neonatal_mother_id" 
                     class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                     placeholder="Opcional - para neonatos" />
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Alergias
              </label>
              <textarea id="allergies" rows="2"
                        class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                        placeholder="Liste as alergias conhecidas (separadas por v√≠rgula)"></textarea>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Condi√ß√µes Pr√©-existentes
              </label>
              <textarea id="conditions" rows="2"
                        class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                        placeholder="Liste as condi√ß√µes m√©dicas (separadas por v√≠rgula)"></textarea>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button type="button" onclick="closePatientModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary px-6 py-2">
              <i class="fas fa-save mr-2"></i>Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  var div = document.createElement('div');
  div.innerHTML = modalHtml;
  document.body.appendChild(div);
  
  var form = document.getElementById('patient-form');
  if (form) form.addEventListener('submit', handlePatientSubmit);
  
  var cpfInput = document.getElementById('document_id');
  if (cpfInput) {
    cpfInput.addEventListener('input', function(e) {
      var v = e.target.value.replace(/\D/g, '');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = v;
    });
  }
}

function closePatientModal() {
  debugLog('‚ùå Fechando modal');
  var modal = document.getElementById('patient-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function handlePatientSubmit(e) {
  e.preventDefault();
  debugLog('üíæ Salvando paciente...');
  
  var patientId = document.getElementById('patient-id').value;
  var allergiesText = document.getElementById('allergies').value.trim();
  var conditionsText = document.getElementById('conditions').value.trim();
  
  var data = {
    full_name: document.getElementById('full_name').value.trim(),
    birth_date: document.getElementById('birth_date').value,
    sex: document.getElementById('sex').value,
    document_id: document.getElementById('document_id').value.replace(/\D/g, ''),
    neonatal_mother_id: document.getElementById('neonatal_mother_id').value.trim(),
    allergies: allergiesText ? allergiesText.split(',').map(function(s) { return s.trim(); }) : [],
    conditions: conditionsText ? conditionsText.split(',').map(function(s) { return s.trim(); }) : []
  };
  
  if (patientId) {
    data.id = patientId;
  }
  
  debugLog('üì§ Dados do paciente', data);
  showLoading();
  
  if (patientId) {
    // update
    google.script.run
      .withSuccessHandler(function(result) {
        debugLog('‚úÖ Paciente atualizado', result);
        hideLoading();
        
        if (result) {
          showSuccess('Paciente atualizado com sucesso!');
          closePatientModal();
          
          // [MERGE] atualizar cache local imediatamente
          var index = INITIAL_PATIENTS.findIndex(function(p) { return p.id === patientId; });
          if (index !== -1) {
            INITIAL_PATIENTS[index] = Object.assign(INITIAL_PATIENTS[index], data);
          }
          
          loadPatients();
        } else {
          showError('Erro ao atualizar paciente');
        }
      })
      .withFailureHandler(function(error) {
        debugLog('‚ùå Erro ao atualizar', error);
        hideLoading();
        showError('Erro ao atualizar paciente: ' + (error.message || error));
      })
      .updatePatient(patientId, data);
  } else {
    // create
    google.script.run
      .withSuccessHandler(function(patient) {
        debugLog('‚úÖ Paciente criado', patient);
        hideLoading();
        
        if (patient && patient.id) {
          showSuccess('Paciente cadastrado com sucesso!');
          closePatientModal();
          
          INITIAL_PATIENTS.push(patient);
          loadPatients();
        } else {
          showError('Erro ao criar paciente');
        }
      })
      .withFailureHandler(function(error) {
        debugLog('‚ùå Erro ao criar', error);
        hideLoading();
        showError('Erro ao cadastrar paciente: ' + (error.message || error));
      })
      .createPatient(data);
  }
}

// Visualizar paciente hoje abre o modal de edi√ß√£o
function viewPatient(id) {
  debugLog('üëÅÔ∏è Visualizar paciente: ' + id);
  editPatient(id);
}

// ============================================================================
// ATENDIMENTO - MODAL E FLUXO
// ============================================================================

function startEncounter(patientId) {
  debugLog('üè• Iniciar atendimento: ' + patientId);
  
  var patient = INITIAL_PATIENTS.find(function(p) { return p.id === patientId; });
  
  if (!patient) {
    showError('Paciente n√£o encontrado');
    return;
  }
  
  currentPatient = patient;
  showEncounterModal();
}

function showEncounterModal() {
  var modal = document.getElementById('encounter-modal');
  if (!modal) {
    createEncounterModal();
    modal = document.getElementById('encounter-modal');
  }
  
  // Preenche informa√ß√µes do paciente
  var nameEl = document.getElementById('encounter-patient-name');
  if (nameEl) nameEl.textContent = currentPatient.full_name;
  var infoEl = document.getElementById('encounter-patient-info');
  if (infoEl) {
    infoEl.textContent = 
      calculateAge(currentPatient.birth_date) + ' anos ‚Ä¢ ' + (currentPatient.sex || '-') + ' ‚Ä¢ CPF: ' + (currentPatient.document_id || '');
  }
  
  // Limpa formul√°rio
  var form = document.getElementById('encounter-form');
  if (form) form.reset();
  
  // Carrega profissionais
  try { loadProfessionalsForEncounter(); } catch (e) { debugLog('‚ö†Ô∏è Falha ao carregar profissionais', e); }
  
  modal.classList.remove('hidden');
}

function createEncounterModal() {
  var modalHtml = `
    <div id="encounter-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10">
          <div>
            <h3 class="text-xl font-bold">Novo Atendimento</h3>
            <p class="text-sm text-blue-100">
              <span id="encounter-patient-name"></span> ‚Ä¢ <span id="encounter-patient-info"></span>
            </p>
          </div>
          <button onclick="closeEncounterModal()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="encounter-form" class="p-6 space-y-6">
          <!-- Informa√ß√µes do Atendimento -->
          <div class="border-b pb-4">
            <h4 class="text-lg font-bold mb-3 text-gray-700">
              <i class="fas fa-info-circle mr-2 text-blue-600"></i>Informa√ß√µes do Atendimento
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Profissional <span class="text-red-500">*</span>
                  <button type="button" onclick="showProfessionalModal()" class="text-xs text-blue-600 underline ml-2">Cadastrar</button> <!-- [MERGE] bot√£o cadastrar inline -->
                </label>
                <select id="encounter-professional" required 
                        class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">Carregando profissionais...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Local <span class="text-red-500">*</span>
                </label>
                <select id="encounter-location" required 
                        class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">Selecione...</option>
                  <option value="AMBULATORIO">Ambulat√≥rio</option>
                  <option value="LEITO">Leito</option>
                  <option value="UTI">UTI</option>
                  <option value="EMERGENCIA">Emerg√™ncia</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Tipo <span class="text-red-500">*</span>
                </label>
                <select id="encounter-type" required 
                        class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">Selecione...</option>
                  <option value="AVALIACAO">Avalia√ß√£o Inicial</option>
                  <option value="REAVALIACAO">Reavalia√ß√£o</option>
                  <option value="TRATAMENTO">Tratamento</option>
                  <option value="ALTA">Alta</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Sinais Vitais -->
          <div class="border-b pb-4">
            <h4 class="text-lg font-bold mb-3 text-gray-700">
              <i class="fas fa-heartbeat mr-2 text-red-600"></i>Sinais Vitais
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">SpO‚ÇÇ (%)</label>
                <input type="number" id="vitals-spo2" min="0" max="100" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="95-100" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FC (bpm)</label>
                <input type="number" id="vitals-hr" min="0" max="300" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="60-100" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FR (ipm)</label>
                <input type="number" id="vitals-rr" min="0" max="100" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="12-20" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">PA Sist√≥lica</label>
                <input type="number" id="vitals-bp-sys" min="0" max="300" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="120" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">PA Diast√≥lica</label>
                <input type="number" id="vitals-bp-dia" min="0" max="200" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="80" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temp (¬∞C)</label>
                <input type="number" id="vitals-temp" min="30" max="45" step="0.1" 
                       class="form-input w-full px-3 py-2 border rounded-lg" placeholder="36.5" />
              </div>
            </div>
          </div>

          <!-- Nota SOAP -->
          <div class="border-b pb-4">
            <h4 class="text-lg font-bold mb-3 text-gray-700">
              <i class="fas fa-file-medical mr-2 text-green-600"></i>Evolu√ß√£o SOAP
            </h4>
            
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold mr-2">S</span>
                  Subjetivo
                </label>
                <textarea id="soap-subjective" rows="2" 
                          class="form-input w-full px-3 py-2 border rounded-lg" 
                          placeholder="O que o paciente relata? Queixas, sintomas..."></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold mr-2">O</span>
                  Objetivo
                </label>
                <textarea id="soap-objective" rows="2" 
                          class="form-input w-full px-3 py-2 border rounded-lg" 
                          placeholder="O que voc√™ observou? Dados objetivos, testes..."></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold mr-2">A</span>
                  Avalia√ß√£o
                </label>
                <textarea id="soap-assessment" rows="2" 
                          class="form-input w-full px-3 py-2 border rounded-lg" 
                          placeholder="Sua interpreta√ß√£o cl√≠nica, diagn√≥stico fisioterap√™utico..."></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs font-bold mr-2">P</span>
                  Plano
                </label>
                <textarea id="soap-plan" rows="2" 
                          class="form-input w-full px-3 py-2 border rounded-lg" 
                          placeholder="Condutas, tratamento planejado, orienta√ß√µes..."></textarea>
              </div>
            </div>
          </div>

          <!-- Bot√µes -->
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="closeEncounterModal()" 
                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary px-6 py-2">
              <i class="fas fa-save mr-2"></i>Salvar Atendimento
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  var div = document.createElement('div');
  div.innerHTML = modalHtml;
  document.body.appendChild(div);
  
  var form = document.getElementById('encounter-form');
  if (form) form.addEventListener('submit', handleEncounterSubmit);
}

function closeEncounterModal() {
  var modal = document.getElementById('encounter-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function handleEncounterSubmit(e) {
  e.preventDefault();
  debugLog('üíæ Salvando atendimento...');
  
  if (!currentPatient) {
    showError('Nenhum paciente selecionado');
    return;
  }
  
  // Profissional obrigat√≥rio
  var profEl = document.getElementById('encounter-professional');
  var professionalId = profEl ? profEl.value : '';
  if (!professionalId) {
    showError('Selecione o profissional do atendimento');
    return;
  }
  
  showLoading();
  
  // 1. Dados do atendimento
  var encounterData = {
    patient_id: currentPatient.id,
    professional_id: professionalId,
    location: document.getElementById('encounter-location').value,
    type: document.getElementById('encounter-type').value
  };
  
  debugLog('üìã Dados do atendimento', encounterData);
  
  // Abre o atendimento primeiro
  google.script.run
    .withSuccessHandler(function(encounter) {
      debugLog('‚úÖ Atendimento aberto', encounter);
      currentEncounter = encounter;
      
      // 2. Salva sinais vitais (se preenchidos)
      saveVitals(encounter.id);
      
      // 3. Salva nota SOAP (se preenchida)
      saveSOAP(encounter.id);
      
      // 4. Fecha o atendimento
      closeEncounterAndFinish(encounter.id);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao abrir atendimento', error);
      hideLoading();
      showError('Erro ao iniciar atendimento: ' + (error.message || error));
    })
    .openEncounter(encounterData);
}

function saveVitals(encounterId) {
  var spo2 = document.getElementById('vitals-spo2').value;
  var hr = document.getElementById('vitals-hr').value;
  var rr = document.getElementById('vitals-rr').value;
  var bpSys = document.getElementById('vitals-bp-sys').value;
  var bpDia = document.getElementById('vitals-bp-dia').value;
  var temp = document.getElementById('vitals-temp').value;
  
  // S√≥ salva se pelo menos um campo foi preenchido
  if (!spo2 && !hr && !rr && !bpSys && !bpDia && !temp) {
    debugLog('‚è≠Ô∏è Nenhum sinal vital preenchido, pulando...');
    return;
  }
  
  var vitalsData = {
    encounter_id: encounterId,
    spo2: spo2,
    hr: hr,
    rr: rr,
    bp_sys: bpSys,
    bp_dia: bpDia,
    temp: temp
  };
  
  debugLog('üíâ Salvando sinais vitais', vitalsData);
  
  google.script.run
    .withSuccessHandler(function(result) {
      debugLog('‚úÖ Sinais vitais salvos', result);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ö†Ô∏è Erro ao salvar sinais vitais', error);
    })
    .recordVitals(vitalsData);
}

function saveSOAP(encounterId) {
  var subjective = document.getElementById('soap-subjective').value.trim();
  var objective = document.getElementById('soap-objective').value.trim();
  var assessment = document.getElementById('soap-assessment').value.trim();
  var plan = document.getElementById('soap-plan').value.trim();
  
  // S√≥ salva se pelo menos um campo foi preenchido
  if (!subjective && !objective && !assessment && !plan) {
    debugLog('‚è≠Ô∏è Nenhuma nota SOAP preenchida, pulando...');
    return;
  }
  
  var soapData = {
    encounter_id: encounterId,
    subjective: subjective,
    objective: objective,
    assessment: assessment,
    plan: plan
  };
  
  debugLog('üìù Salvando nota SOAP', soapData);
  
  google.script.run
    .withSuccessHandler(function(result) {
      debugLog('‚úÖ Nota SOAP salva', result);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ö†Ô∏è Erro ao salvar nota SOAP', error);
    })
    .addSessionNote(soapData);
}

function closeEncounterAndFinish(encounterId) {
  debugLog('üîí Fechando atendimento', encounterId);
  
  google.script.run
    .withSuccessHandler(function(success) {
      debugLog('‚úÖ Atendimento fechado', success);
      hideLoading();
      showSuccess('Atendimento registrado com sucesso!');
      closeEncounterModal();
      currentEncounter = null;
      
      // Atualiza dashboard
      loadDashboardStats();
    })
    .withFailureHandler(function(error) {
      debugLog('‚ö†Ô∏è Erro ao fechar atendimento', error);
      hideLoading();
      showError('Atendimento salvo, mas erro ao finalizar: ' + (error.message || error));
      closeEncounterModal();
    })
    .closeEncounter(encounterId);
}

// ============================================================================
// PROFISSIONAIS
// ============================================================================

function loadProfessionalsForEncounter() {
  var select = document.getElementById('encounter-professional');
  if (!select) return;
  
  debugLog('üë• Carregando profissionais...');
  select.innerHTML = '<option value="">Carregando profissionais...</option>';

  google.script.run
    .withSuccessHandler(function(resp) {
      debugLog('‚úÖ Profissionais recebidos', resp);
      
      var list = (resp && resp.data) ? resp.data : [];
      if (!Array.isArray(list) || list.length === 0) {
        select.innerHTML = '<option value="">Nenhum profissional encontrado</option>';
        return;
      }
      
      var html = '<option value="">Selecione o profissional...</option>';
      list.forEach(function(p) {
        var label = (p.full_name || p.email || p.id || '').toString();
        var crefito = p.crefito ? (' - CREFITO: ' + p.crefito) : '';
        html += '<option value="' + p.id + '">' + escapeHtml(label) + crefito + '</option>';
      });
      select.innerHTML = html;
      
      debugLog('‚úÖ ' + list.length + ' profissionais carregados no select');
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao carregar profissionais', error);
      select.innerHTML = '<option value="">Erro ao carregar profissionais</option>';
      showError('Erro ao carregar profissionais: ' + (error.message || error));
    })
    .handleApiGet({ path: '/api/professionals' });
}

/**
 * [MERGE] Modal r√°pido de cadastro de profissional que existia no fonte antigo
 * usado dentro do fluxo de atendimento
 */
function showProfessionalModal() {
  var m = document.getElementById('professional-modal');
  if (!m) { createProfessionalModal(); m = document.getElementById('professional-modal'); }
  var f = document.getElementById('professional-form');
  if (f) f.reset();
  m.classList.remove('hidden');
}

function closeProfessionalModal() {
  var m = document.getElementById('professional-modal');
  if (m) m.classList.add('hidden');
}

function createProfessionalModal() {
  var html = `
    <div id="professional-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
          <h3 class="text-xl font-bold">Cadastrar Profissional</h3>
          <button onclick="closeProfessionalModal()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <form id="professional-form" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo <span class="text-red-500">*</span></label>
            <input type="text" id="prof_full_name" required class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nome do profissional" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
            <input type="email" id="prof_email" required class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="email@exemplo.com" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">CREFITO</label>
            <input type="text" id="prof_crefito" class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Opcional" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fun√ß√£o <span class="text-red-500">*</span></label>
            <select id="prof_role" required class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="FISIO">FISIO</option>
              <option value="COORD">COORD</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button type="button" onclick="closeProfessionalModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
            <button type="submit" class="btn-primary px-6 py-2"><i class="fas fa-save mr-2"></i>Salvar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  var w = document.createElement('div');
  w.innerHTML = html;
  document.body.appendChild(w);
  var f = document.getElementById('professional-form');
  if (f) f.addEventListener('submit', handleProfessionalSubmit);
}

function handleProfessionalSubmit(e) {
  e.preventDefault();
  var data = {
    full_name: document.getElementById('prof_full_name').value.trim(),
    email: document.getElementById('prof_email').value.trim(),
    crefito: document.getElementById('prof_crefito').value.trim(),
    role: document.getElementById('prof_role').value,
    status: 'ACTIVE'
  };
  if (!data.full_name || !data.email || !data.role) {
    showError('Preencha os campos obrigat√≥rios');
    return;
  }
  showLoading();
  google.script.run
    .withSuccessHandler(function(resp) {
      hideLoading();
      if (resp && resp.success && resp.data && resp.data.id) {
        showSuccess('Profissional cadastrado com sucesso!');
        closeProfessionalModal();
        loadProfessionalsForEncounter();
        var sel = document.getElementById('encounter-professional');
        if (sel) sel.value = resp.data.id;
      } else {
        showError('Erro ao cadastrar profissional');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erro ao cadastrar profissional: ' + (error.message || error));
    })
    .handleApiPost('/api/professionals', data);
}

/**
 * Modal dashboard mais completo (do fonte novo)
 */
function showProfessionalModalFromDashboard() {
  debugLog('üë®‚Äç‚öïÔ∏è Abrindo modal de cadastro de profissional (dashboard)');
  
  var modal = document.getElementById('professional-modal-dashboard');
  if (!modal) {
    createProfessionalModalDashboard();
    modal = document.getElementById('professional-modal-dashboard');
  }
  
  var form = document.getElementById('professional-form-dashboard');
  if (form) form.reset();
  
  modal.classList.remove('hidden');
}

function closeProfessionalModalDashboard() {
  var modal = document.getElementById('professional-modal-dashboard');
  if (modal) modal.classList.add('hidden');
}

function createProfessionalModalDashboard() {
  var html = `
    <div id="professional-modal-dashboard" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
          <h3 class="text-xl font-bold">
            <i class="fas fa-user-md mr-2"></i>Cadastrar Profissional
          </h3>
          <button onclick="closeProfessionalModalDashboard()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="professional-form-dashboard" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Nome Completo <span class="text-red-500">*</span>
            </label>
            <input type="text" id="prof_full_name_dash" required 
                   class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="Nome do profissional" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Email <span class="text-red-500">*</span>
            </label>
            <input type="email" id="prof_email_dash" required 
                   class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="email@exemplo.com" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              CREFITO
            </label>
            <input type="text" id="prof_crefito_dash" 
                   class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="Opcional - Ex: CREFITO-1/12345-F" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Fun√ß√£o <span class="text-red-500">*</span>
            </label>
            <select id="prof_role_dash" required 
                    class="form-input w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Selecione...</option>
              <option value="FISIO">Fisioterapeuta</option>
              <option value="COORD">Coordenador</option>
            </select>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <p class="text-sm text-blue-800">
              <i class="fas fa-info-circle mr-2"></i>
              O profissional ser√° cadastrado como <strong>ATIVO</strong> e poder√° ser selecionado nos atendimentos.
            </p>
          </div>
          
          <div class="flex justify-end space-x-3 pt-4 border-t">
            <button type="button" onclick="closeProfessionalModalDashboard()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary px-6 py-2">
              <i class="fas fa-save mr-2"></i>Cadastrar
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  var wrapper = document.createElement('div');
  wrapper.innerHTML = html;
  document.body.appendChild(wrapper);
  
  var form = document.getElementById('professional-form-dashboard');
  if (form) form.addEventListener('submit', handleProfessionalSubmitDashboard);
}

function handleProfessionalSubmitDashboard(e) {
  e.preventDefault();
  
  var data = {
    full_name: document.getElementById('prof_full_name_dash').value.trim(),
    email: document.getElementById('prof_email_dash').value.trim(),
    crefito: document.getElementById('prof_crefito_dash').value.trim(),
    role: document.getElementById('prof_role_dash').value,
    status: 'ACTIVE'
  };
  
  if (!data.full_name || !data.email || !data.role) {
    showError('Preencha todos os campos obrigat√≥rios');
    return;
  }
  
  debugLog('üíæ Cadastrando profissional...', data);
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(resp) {
      hideLoading();
      debugLog('‚úÖ Profissional cadastrado', resp);
      
      if (resp && resp.success && resp.data && resp.data.id) {
        showSuccess('Profissional cadastrado com sucesso!');
        closeProfessionalModalDashboard();
      } else {
        showError('Erro ao cadastrar profissional');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      debugLog('‚ùå Erro ao cadastrar profissional', error);
      showError('Erro ao cadastrar profissional: ' + (error.message || error));
    })
    .handleApiPost('/api/professionals', data);
}

// ============================================================================
// ATENDIMENTOS - LISTAGEM, DETALHES, FALLBACK
// ============================================================================

function loadEncounters() {
  debugLog('üìã Carregando aba de atendimentos');
  loadEncountersTab(); // Popula o filtro de pacientes
}

/**
 * Carrega op√ß√µes de pacientes no filtro
 */
function loadEncountersTab() {
  debugLog('üìã Carregando aba de atendimentos');
  
  var selectEl = document.getElementById('encounter-patient-filter');
  if (!selectEl) {
    debugLog('‚ö†Ô∏è Select de filtro n√£o encontrado');
    return;
  }
  
  // Verifica se h√° pacientes carregados
  debugLog('üì¶ Pacientes dispon√≠veis: ' + INITIAL_PATIENTS.length);
  
  // Usa pacientes do cache
  if (INITIAL_PATIENTS.length === 0) {
    debugLog('‚ö†Ô∏è Nenhum paciente no cache, tentando recarregar...');
    
    // Tenta carregar pacientes do servidor
    google.script.run
      .withSuccessHandler(function(patients) {
        debugLog('‚úÖ Pacientes carregados do servidor: ' + patients.length);
        INITIAL_PATIENTS = patients || [];
        populatePatientSelect();
      })
      .withFailureHandler(function(error) {
        debugLog('‚ùå Erro ao carregar pacientes', error);
        selectEl.innerHTML = '<option value="">Erro ao carregar pacientes</option>';
      })
      .getFrontendPatients();
    
    return;
  }
  
  populatePatientSelect();
}

/**
 * Popula o select com pacientes
 */
function populatePatientSelect() {
  var selectEl = document.getElementById('encounter-patient-filter');
  if (!selectEl) return;
  
  var html = '<option value="">Selecione um paciente...</option>';
  
  INITIAL_PATIENTS.forEach(function(p) {
    var age = calculateAge(p.birth_date);
    var cpf = p.document_id ? String(p.document_id) : 'Sem CPF';
    
    html += '<option value="' + p.id + '">' + 
            escapeHtml(p.full_name) + ' - ' + age + ' anos - CPF: ' + 
            escapeHtml(cpf) + '</option>';
  });
  
  selectEl.innerHTML = html;
  debugLog('‚úÖ Select populado com ' + INITIAL_PATIENTS.length + ' pacientes');
}

/**
 * Busca os atendimentos de um paciente selecionado
 */
function loadPatientEncounters() {
  var selectEl = document.getElementById('encounter-patient-filter');
  var patientId = selectEl ? selectEl.value : '';
  
  debugLog('üîç Filtrando atendimentos do paciente: ' + patientId);
  
  var listEl = document.getElementById('encounters-list');
  if (!listEl) {
    debugLog('‚ö†Ô∏è Container encounters-list n√£o encontrado');
    return;
  }
  
  if (!patientId) {
    listEl.innerHTML = `
      <div class="text-center py-12 text-gray-400">
        <i class="fas fa-filter text-6xl mb-4"></i>
        <p class="text-lg">Nenhum paciente selecionado</p>
        <p class="text-sm">Use o filtro acima para buscar atendimentos</p>
      </div>
    `;
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(response) {
      debugLog('‚úÖ Atendimentos recebidos', response);
      hideLoading();
      
      if (!response || !response.data) {
        showError('Erro ao carregar atendimentos');
        return;
      }
      
      renderEncountersList(response.data, patientId);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao carregar atendimentos', error);
      hideLoading();
      showError('Erro ao buscar atendimentos: ' + (error.message || error));
    })
    .handleApiGet({ path: '/api/encounters/patient', patient_id: patientId });
}

/**
 * Renderiza lista de atendimentos
 * [MERGE] vers√£o nova + cache local ENCOUNTERS_CACHE_BY_ID do antigo
 */
function renderEncountersList(encounters, patientId) {
  var listEl = document.getElementById('encounters-list');
  
  if (!encounters || encounters.length === 0) {
    listEl.innerHTML = `
      <div class="text-center py-12 text-gray-400">
        <i class="fas fa-clipboard text-6xl mb-4"></i>
        <p class="text-lg">Nenhum atendimento encontrado</p>
        <p class="text-sm">Este paciente ainda n√£o possui atendimentos registrados</p>
      </div>
    `;
    return;
  }
  
  debugLog('üé® Renderizando ' + encounters.length + ' atendimentos');
  
  var html = '<div class="space-y-4">';
  
  encounters.forEach(function(enc) {
    // [MERGE] guarda no cache local para fallback de detalhes depois
    try { window.ENCOUNTERS_CACHE_BY_ID[enc.id] = enc; } catch (e) {}
    
    var statusBadge = enc.status === 'OPEN' 
      ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Em Andamento</span>'
      : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Finalizado</span>';
    
    var startDate = formatDateTime(enc.started_at);
    var endDate = enc.ended_at ? formatDateTime(enc.ended_at) : '-';
    
    html += `
      <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-bold text-lg text-gray-800">
              <i class="fas fa-stethoscope text-blue-600 mr-2"></i>${escapeHtml(enc.type)}
            </h3>
            <p class="text-sm text-gray-600">
              <i class="fas fa-user-md mr-1"></i>${escapeHtml(enc.professional_name)} 
              ${enc.professional_crefito ? '(CREFITO: ' + escapeHtml(enc.professional_crefito) + ')' : ''}
            </p>
          </div>
          ${statusBadge}
        </div>
        
        <div class="grid grid-cols-2 gap-3 text-sm mb-3">
          <div>
            <span class="text-gray-500">In√≠cio:</span>
            <span class="font-medium ml-1">${startDate}</span>
          </div>
          <div>
            <span class="text-gray-500">Fim:</span>
            <span class="font-medium ml-1">${endDate}</span>
          </div>
          <div>
            <span class="text-gray-500">Local:</span>
            <span class="font-medium ml-1">${escapeHtml(enc.location)}</span>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-2 text-xs mb-3">
          ${enc.notes && enc.notes.length > 0 ? 
            '<span class="bg-blue-50 text-blue-700 px-2 py-1 rounded"><i class="fas fa-file-medical mr-1"></i>' + enc.notes.length + ' nota(s) SOAP</span>' : ''}
          ${enc.vitals && enc.vitals.length > 0 ? 
            '<span class="bg-red-50 text-red-700 px-2 py-1 rounded"><i class="fas fa-heartbeat mr-1"></i>' + enc.vitals.length + ' sinais vitais</span>' : ''}
          ${enc.assessments && enc.assessments.length > 0 ? 
            '<span class="bg-green-50 text-green-700 px-2 py-1 rounded"><i class="fas fa-clipboard-check mr-1"></i>' + enc.assessments.length + ' avalia√ß√£o(√µes)</span>' : ''}
        </div>
        
        <div class="flex gap-2 pt-3 border-t">
          <button onclick="viewEncounterDetails('${enc.id}')" 
                  class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
            <i class="fas fa-eye mr-1"></i>Ver Detalhes
          </button>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  listEl.innerHTML = html;
  debugLog('‚úÖ Lista renderizada');
}

/**
 * Limpa filtro de paciente
 */
function clearEncounterFilter() {
  var selectEl = document.getElementById('encounter-patient-filter');
  if (selectEl) {
    selectEl.value = '';
  }
  
  var listEl = document.getElementById('encounters-list');
  if (listEl) {
    listEl.innerHTML = `
      <div class="text-center py-12 text-gray-400">
        <i class="fas fa-filter text-6xl mb-4"></i>
        <p class="text-lg">Nenhum paciente selecionado</p>
        <p class="text-sm">Use o filtro acima para buscar atendimentos</p>
      </div>
    `;
  }
}

/**
 * Formata data/hora para exibi√ß√£o
 */
function formatDateTime(isoString) {
  if (!isoString) return '-';
  
  try {
    var date = new Date(isoString);
    var day = ('0' + date.getDate()).slice(-2);
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var year = date.getFullYear();
    var hours = ('0' + date.getHours()).slice(-2);
    var minutes = ('0' + date.getMinutes()).slice(-2);
    
    return day + '/' + month + '/' + year + ' ' + hours + ':' + minutes;
  } catch (e) {
    return '-';
  }
}

// ============================================================================
// DETALHES DO ATENDIMENTO (MODAL DE LEITURA)
// ============================================================================

/**
 * Visualiza detalhes completos do atendimento
 * Usa m√∫ltiplas tentativas e fallback local
 */
function viewEncounterDetails(encounterId) {
  debugLog('üëÅÔ∏è Visualizando atendimento: ' + encounterId);
  debugLog('Encounter ID recebido: ' + encounterId);
  debugLog('Tipo do ID: ' + typeof encounterId);
  
  showLoading();
  
  // TENTATIVA 1: Via handleApiGet
  google.script.run
    .withSuccessHandler(function(response) {
      debugLog('‚úÖ Resposta handleApiGet recebida', response);
      debugLog('Tipo da resposta: ' + typeof response);
      debugLog('Response √© null?: ' + (response === null));
      debugLog('Response √© undefined?: ' + (response === undefined));
      
      if (response) {
        debugLog('Response.success: ' + response.success);
        debugLog('Response.data existe?: ' + (response.data !== undefined));
        debugLog('Response.error: ' + response.error);
      }
      
      hideLoading();
      
      if (!response) {
        debugLog('‚ö†Ô∏è Resposta vazia, tentando m√©todo alternativo...');
        tryDirectMethod(encounterId);
        return;
      }
      
      if (response.error) {
        debugLog('‚ö†Ô∏è Erro na resposta: ' + response.error);
        // TENTATIVA 1b: reenviar usando encounter_id
        debugLog('‚ö†Ô∏è Tentando novamente com encounter_id...');
        tryWithEncounterId(encounterId);
        return; 
      }
      
      var data = response.data;
      
      if (!data) {
        debugLog('‚ö†Ô∏è response.data vazio, tentando m√©todo alternativo...');
        tryDirectMethod(encounterId);
        return;
      }
      
      debugLog('‚úÖ Dados v√°lidos recebidos, exibindo modal...');
      debugLog('Data.encounter existe?: ' + (data.encounter !== undefined));
      debugLog('Data.patient existe?: ' + (data.patient !== undefined));
      
      showEncounterDetailsModal(data);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Falha no handleApiGet', error);
      hideLoading();
      
      debugLog('‚ö†Ô∏è Tentando m√©todo alternativo...');
      tryDirectMethod(encounterId);
    })
    .handleApiGet({ path: '/api/encounters/details', id: encounterId });
}

// TENTATIVA 1b: Repetir chamada passando encounter_id ao inv√©s de id
function tryWithEncounterId(encounterId) {
  showLoading();
  google.script.run
    .withSuccessHandler(function(response) {
      debugLog('‚úÖ Resposta com encounter_id recebida', response);
      hideLoading();
      if (response && response.data) {
        showEncounterDetailsModal(response.data);
        return;
      }
      // Segue para m√©todo direto
      tryDirectMethod(encounterId);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Falha com encounter_id', error);
      hideLoading();
      tryDirectMethod(encounterId);
    })
    .handleApiGet({ path: '/api/encounters/details', encounter_id: encounterId });
}

/**
 * M√âTODO ALTERNATIVO: Chama getEncounterDetails diretamente
 */
function tryDirectMethod(encounterId) {
  debugLog('üîÑ Tentando m√©todo direto: getEncounterDetails');
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(details) {
      debugLog('‚úÖ Resposta m√©todo direto recebida', details);
      hideLoading();
      
      if (!details) {
        debugLog('‚ö†Ô∏è M√©todo direto retornou vazio; tentando fallback local...');
        tryLocalFallback(encounterId);
        return;
      }
      
      showEncounterDetailsModal(details);
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Falha no m√©todo direto', error);
      hideLoading();
      // √öltima tentativa: Fallback local
      tryLocalFallback(encounterId);
    })
    .getEncounterDetails(encounterId);
}

// Fallback local: usa dados j√° renderizados em ENCOUNTERS_CACHE_BY_ID para exibir algo √∫til
function tryLocalFallback(encounterId) {
  try {
    var enc = (window.ENCOUNTERS_CACHE_BY_ID || {})[encounterId];
    if (!enc) {
      showError('Atendimento n√£o encontrado');
      return;
    }
    // tenta recuperar paciente do cache
    var patient = null;
    try {
      var pid = enc.patient_id;
      patient = (INITIAL_PATIENTS || []).find(function(p){ return p.id === pid; }) || {};
    } catch (e) { patient = {}; }
    var data = {
      encounter: {
        id: enc.id,
        patient_id: enc.patient_id,
        started_at: enc.started_at,
        ended_at: enc.ended_at,
        location: enc.location,
        type: enc.type
      },
      patient: patient,
      professional: { full_name: enc.professional_name || 'N/A', crefito: enc.professional_crefito || '' },
      notes: enc.notes || [],
      vitals: enc.vitals || [],
      assessments: enc.assessments || [],
      procedures: enc.procedures || []
    };
    showEncounterDetailsModal(data);
  } catch (e) {
    showError('Erro ao exibir detalhes: ' + (e && e.message ? e.message : e));
  }
}

/**
 * [MERGE] Abaixo: toda a estrutura de modal de detalhes do atendimento
 * que existia completa no fonte antigo e n√£o estava no novo.
 */

function showEncounterDetailsModal(data) {
  debugLog('üìã showEncounterDetailsModal chamada', data);
  debugLog('Data recebido - tipo: ' + typeof data);
  debugLog('Data.encounter existe?: ' + (data && data.encounter !== undefined));
  
  var modal = document.getElementById('encounter-details-modal');
  
  if (!modal) {
    debugLog('‚ö†Ô∏è Modal n√£o encontrado, criando...');
    createEncounterDetailsModal();
    modal = document.getElementById('encounter-details-modal');
  }
  
  if (!modal) {
    debugLog('‚ùå ERRO: N√£o foi poss√≠vel criar o modal');
    showError('Erro ao criar modal de detalhes');
    return;
  }
  
  debugLog('‚úÖ Modal encontrado, preenchendo detalhes...');
  
  // Preenche informa√ß√µes
  fillEncounterDetails(data);
  
  debugLog('‚úÖ Detalhes preenchidos, exibindo modal...');
  modal.classList.remove('hidden');
  
  debugLog('‚úÖ Modal exibido com sucesso');
}

function createEncounterDetailsModal() {
  var modalHtml = `
    <div id="encounter-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center sticky top-0 z-10">
          <div>
            <h3 class="text-xl font-bold">Detalhes do Atendimento</h3>
            <p id="encounter-detail-subtitle" class="text-sm text-blue-100"></p>
          </div>
          <button onclick="closeEncounterDetailsModal()" class="text-white hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div id="encounter-detail-content" class="p-6">
          <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>
  `;
  
  var div = document.createElement('div');
  div.innerHTML = modalHtml;
  document.body.appendChild(div);
}

function fillEncounterDetails(data) {
  debugLog('üìã fillEncounterDetails chamada');
  debugLog('Data tipo: ' + typeof data);
  debugLog('Data √© null?: ' + (data === null));
  debugLog('Data √© undefined?: ' + (data === undefined));
  
  if (data) {
    debugLog('Data.encounter: ' + (data.encounter ? 'EXISTS' : 'NULL'));
    debugLog('Data.patient: ' + (data.patient ? 'EXISTS' : 'NULL'));
    debugLog('Data.professional: ' + (data.professional ? 'EXISTS' : 'NULL'));
  }
  
  var subtitleEl = document.getElementById('encounter-detail-subtitle');
  var contentEl = document.getElementById('encounter-detail-content');
  
  debugLog('subtitleEl encontrado?: ' + (subtitleEl !== null));
  debugLog('contentEl encontrado?: ' + (contentEl !== null));
  
  if (!data || !data.encounter) {
    debugLog('‚ùå Dados inv√°lidos ou encounter ausente');
    if (contentEl) {
      contentEl.innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar detalhes do atendimento</p>';
    }
    return;
  }
  
  debugLog('‚úÖ Dados v√°lidos, montando HTML...');
  
  var enc = data.encounter;
  var patient = data.patient || {};
  var professional = data.professional || {};
  var notes = data.notes || [];
  var vitals = data.vitals || [];
  var assessments = data.assessments || [];
  var procedures = data.procedures || [];
  
  // Subt√≠tulo com informa√ß√µes b√°sicas
  if (subtitleEl) {
    subtitleEl.textContent = (patient.full_name || 'Paciente') + ' ‚Ä¢ ' + formatDateTime(enc.started_at);
  }
  
  var html = '';
  
  // 1. INFORMA√á√ïES DO ATENDIMENTO
  html += '<div class="mb-6 border-b pb-4">';
  html += '  <h4 class="text-lg font-bold mb-3 text-gray-700">';
  html += '    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Informa√ß√µes do Atendimento';
  html += '  </h4>';
  html += '  <div class="grid grid-cols-2 gap-4 text-sm">';
  html += '    <div><span class="text-gray-500">Profissional:</span> <span class="font-medium">' + escapeHtml(professional.full_name || 'N/A') + '</span></div>';
  html += '    <div><span class="text-gray-500">CREFITO:</span> <span class="font-medium">' + escapeHtml(professional.crefito || '-') + '</span></div>';
  html += '    <div><span class="text-gray-500">Local:</span> <span class="font-medium">' + escapeHtml(enc.location || '-') + '</span></div>';
  html += '    <div><span class="text-gray-500">Tipo:</span> <span class="font-medium">' + escapeHtml(enc.type || '-') + '</span></div>';
  html += '    <div><span class="text-gray-500">In√≠cio:</span> <span class="font-medium">' + formatDateTime(enc.started_at) + '</span></div>';
  html += '    <div><span class="text-gray-500">Fim:</span> <span class="font-medium">' + (enc.ended_at ? formatDateTime(enc.ended_at) : 'Em andamento') + '</span></div>';
  html += '  </div>';
  html += '</div>';
  
  // 2. SINAIS VITAIS
  if (vitals.length > 0) {
    html += '<div class="mb-6 border-b pb-4">';
    html += '  <h4 class="text-lg font-bold mb-3 text-gray-700">';
    html += '    <i class="fas fa-heartbeat mr-2 text-red-600"></i>Sinais Vitais';
    html += '  </h4>';
    
    vitals.forEach(function(v) {
      html += '<div class="bg-gray-50 p-3 rounded mb-2">';
      html += '  <p class="text-xs text-gray-500 mb-2">' + formatDateTime(v.recorded_at) + '</p>';
      html += '  <div class="grid grid-cols-3 md:grid-cols-6 gap-3 text-sm">';
      
      if (v.spo2) html += '<div><span class="text-gray-600">SpO‚ÇÇ:</span> <span class="font-bold">' + v.spo2 + '%</span></div>';
      if (v.hr) html += '<div><span class="text-gray-600">FC:</span> <span class="font-bold">' + v.hr + ' bpm</span></div>';
      if (v.rr) html += '<div><span class="text-gray-600">FR:</span> <span class="font-bold">' + v.rr + ' ipm</span></div>';
      if (v.bp_sys && v.bp_dia) html += '<div><span class="text-gray-600">PA:</span> <span class="font-bold">' + v.bp_sys + '/' + v.bp_dia + ' mmHg</span></div>';
      if (v.temp) html += '<div><span class="text-gray-600">Temp:</span> <span class="font-bold">' + v.temp + '¬∞C</span></div>';
      
      html += '  </div>';
      html += '</div>';
    });
    
    html += '</div>';
  }
  
  // 3. NOTAS SOAP
  if (notes.length > 0) {
    html += '<div class="mb-6 border-b pb-4">';
    html += '  <h4 class="text-lg font-bold mb-3 text-gray-700">';
    html += '    <i class="fas fa-file-medical mr-2 text-green-600"></i>Evolu√ß√£o SOAP';
    html += '  </h4>';
    
    notes.forEach(function(n) {
      html += '<div class="bg-gray-50 p-4 rounded mb-3">';
      html += '  <p class="text-xs text-gray-500 mb-3">' + formatDateTime(n.recorded_at) + '</p>';
      
      if (n.subjective) {
        html += '<div class="mb-3">';
        html += '  <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold mr-2">S</span>';
        html += '  <span class="text-sm text-gray-700">' + escapeHtml(n.subjective) + '</span>';
        html += '</div>';
      }
      
      if (n.objective) {
        html += '<div class="mb-3">';
        html += '  <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold mr-2">O</span>';
        html += '  <span class="text-sm text-gray-700">' + escapeHtml(n.objective) + '</span>';
        html += '</div>';
      }
      
      if (n.assessment) {
        html += '<div class="mb-3">';
        html += '  <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold mr-2">A</span>';
        html += '  <span class="text-sm text-gray-700">' + escapeHtml(n.assessment) + '</span>';
        html += '</div>';
      }
      
      if (n.plan) {
        html += '<div>';
        html += '  <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs font-bold mr-2">P</span>';
        html += '  <span class="text-sm text-gray-700">' + escapeHtml(n.plan) + '</span>';
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    html += '</div>';
  }
  
  // 4. AVALIA√á√ïES
  if (assessments.length > 0) {
    html += '<div class="mb-6 border-b pb-4">';
    html += '  <h4 class="text-lg font-bold mb-3 text-gray-700">';
    html += '    <i class="fas fa-clipboard-check mr-2 text-purple-600"></i>Avalia√ß√µes';
    html += '  </h4>';
    
    assessments.forEach(function(a) {
      html += '<div class="bg-gray-50 p-3 rounded mb-2">';
      html += '  <div class="flex justify-between items-start mb-2">';
      html += '    <span class="font-bold text-gray-700">' + escapeHtml(a.tool) + '</span>';
      html += '    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-bold">Score: ' + (a.score || 0) + '</span>';
      html += '  </div>';
      html += '  <p class="text-xs text-gray-500">' + formatDateTime(a.recorded_at) + '</p>';
      html += '</div>';
    });
    
    html += '</div>';
  }
  
  // 5. PROCEDIMENTOS
  if (procedures.length > 0) {
    html += '<div class="mb-6">';
    html += '  <h4 class="text-lg font-bold mb-3 text-gray-700">';
    html += '    <i class="fas fa-tasks mr-2 text-orange-600"></i>Procedimentos';
    html += '  </h4>';
    
    procedures.forEach(function(p) {
      html += '<div class="bg-gray-50 p-3 rounded mb-2">';
      html += '  <div class="flex justify-between items-start">';
      html += '    <div>';
      html += '      <span class="font-medium text-gray-700">' + escapeHtml(p.description || 'Sem descri√ß√£o') + '</span>';
      html += '      <p class="text-xs text-gray-500 mt-1">' + formatDateTime(p.recorded_at) + '</p>';
      html += '    </div>';
      if (p.code) {
        html += '    <span class="text-xs bg-gray-200 px-2 py-1 rounded">' + escapeHtml(p.code) + '</span>';
      }
      html += '  </div>';
      html += '</div>';
    });
    
    html += '</div>';
  }
  
  // Sem dados cl√≠nicos
  if (vitals.length === 0 && notes.length === 0 && assessments.length === 0 && procedures.length === 0) {
    html += '<div class="text-center py-8 text-gray-400">';
    html += '  <i class="fas fa-inbox text-6xl mb-4"></i>';
    html += '  <p class="text-lg">Nenhum dado cl√≠nico registrado</p>';
    html += '  <p class="text-sm">Este atendimento n√£o possui sinais vitais, notas SOAP, avalia√ß√µes ou procedimentos</p>';
    html += '</div>';
  }
  
  contentEl.innerHTML = html;
  debugLog('‚úÖ Detalhes renderizados');
}

function closeEncounterDetailsModal() {
  var modal = document.getElementById('encounter-details-modal');
  if (modal) modal.classList.add('hidden');
}

// ============================================================================
// FUN√á√ïES AUXILIARES GERAIS
// ============================================================================

function calculateAge(birthDate) {
  if (!birthDate) return '-';
  try {
    var today = new Date();
    var birth = new Date(birthDate);
    var age = today.getFullYear() - birth.getFullYear();
    var md = today.getMonth() - birth.getMonth();
    if (md < 0 || (md === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return isNaN(age) ? '-' : age;
  } catch (e) {
    return '-';
  }
}

function escapeHtml(text) {
  if (!text && text !== 0) return '';
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
}

function showLoading() {
  var el = document.getElementById('loading');
  if (el) el.classList.remove('hidden');
}

function hideLoading() {
  var el = document.getElementById('loading');
  if (el) el.classList.add('hidden');
}

function showSuccess(message) {
  console.log('[SUCCESS]', message);
  var alert = '<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in">' +
    '<i class="fas fa-check-circle mr-2"></i>' + escapeHtml(message) +
    '</div>';
  var el = document.createElement('div');
  el.innerHTML = alert;
  document.body.appendChild(el);
  setTimeout(function() {
    el.remove();
  }, 3000);
}

function showError(message) {
  console.error('[ERROR]', message);
  hideLoading();
  
  var alert = '<div class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in">' +
    '<i class="fas fa-exclamation-circle mr-2"></i>' + escapeHtml(message) +
    '</div>';
  var alertEl = document.createElement('div');
  alertEl.innerHTML = alert;
  document.body.appendChild(alertEl);
  setTimeout(function() {
    alertEl.remove();
  }, 5000);
}

console.log('‚úÖ Sistema carregado completamente');
/**
 * ============================================================================
 * RELAT√ìRIOS - Frontend JavaScript
 * Fun√ß√µes para gerar e exibir Ficha de Avalia√ß√£o
 * ============================================================================
 */

/**
 * ‚úÖ NOVA FUN√á√ÉO: Gera Ficha de Avalia√ß√£o em nova janela
 */
function generateFichaAvaliacao(params) {
  debugLog('üìã Gerando Ficha de Avalia√ß√£o...', params);
  
  showLoading();
  
  // Busca dados completos do paciente
  google.script.run
    .withSuccessHandler(function(data) {
      debugLog('‚úÖ Dados recebidos para ficha', data);
      hideLoading();
      
      if (!data || !data.patient) {
        showError('Erro ao carregar dados do paciente');
        return;
      }
      
      // Abre ficha em nova janela
      openFichaAvaliacaoWindow(data);
      
      showSuccess('Ficha de Avalia√ß√£o gerada com sucesso!');
    })
    .withFailureHandler(function(error) {
      debugLog('‚ùå Erro ao gerar ficha', error);
      hideLoading();
      showError('Erro ao gerar ficha: ' + (error.message || error));
    })
    .generateReportData(params);
}

/**
 * ‚úÖ Abre janela com a Ficha de Avalia√ß√£o preenchida
 */
function openFichaAvaliacaoWindow(data) {
  debugLog('ü™ü Abrindo janela da ficha...');
  
  // Template HTML da ficha (inline)
  var fichaHTML = buildFichaAvaliacaoHTML(data);
  
  // Abre em nova janela
  var fichaWindow = window.open('', '_blank', 'width=900,height=800');
  
  if (!fichaWindow) {
    showError('Popup bloqueado! Permita popups para este site.');
    return;
  }
  
  fichaWindow.document.write(fichaHTML);
  fichaWindow.document.close();
  
  debugLog('‚úÖ Janela da ficha aberta');
}

/**
 * ‚úÖ Constr√≥i HTML completo da Ficha de Avalia√ß√£o
 */
function buildFichaAvaliacaoHTML(data) {
  var patient = data.patient;
  var encounters = data.encounters || [];
  var lastEncounter = encounters[0] || {};
  var notes = lastEncounter.notes || [];
  var vitals = lastEncounter.vitals || [];
  var lastNote = notes[0] || {};
  var lastVital = vitals[0] || {};
  
  // Processa dados
  var idade = calculateAge(patient.birth_date);
  var sexo = patient.sex === 'M' ? 'Masculino' : 'Feminino';
  var cpf = formatCPF(patient.document_id || '');
  var dataAvaliacao = lastEncounter.started_at ? formatDateBR(lastEncounter.started_at) : '__/__/____';
  
  // Alergias e condi√ß√µes
  var alergias = formatAllergies(patient.allergies_json);
  var condicoes = formatConditions(patient.conditions_json);
  
  // Profissional
  var fisioterapeutaNome = lastEncounter.professional_name || '';
  var fisioterapeutaCrefito = lastEncounter.professional_crefito || '';
  
  // Peso e altura
  var peso = lastVital.weight ? lastVital.weight + ' kg' : '___ kg';
  var altura = lastVital.height ? lastVital.height + ' cm' : '___ cm';
  
  // Notas SOAP
  var queixaPrincipal = escapeHtml(lastNote.subjective || '');
  var historicoAtual = escapeHtml(lastNote.objective || '');
  var diagnostico = escapeHtml(lastNote.assessment || '');
  
  // Monta HTML completo
  var html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de Avalia√ß√£o - ${escapeHtml(patient.full_name)}</title>
  <style>
    @page { size: A4; margin: 1.5cm; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      font-size: 11pt;
      line-height: 1.4;
      color: #000;
      padding: 20px;
    }
    .header {
      text-align: center;
      border: 2px solid #000;
      padding: 12px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    .header h1 {
      font-size: 18pt;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .section {
      border: 2px solid #000;
      margin-bottom: 15px;
      page-break-inside: avoid;
    }
    .section-header {
      background: #e0e0e0;
      padding: 6px 10px;
      font-weight: bold;
      border-bottom: 2px solid #000;
    }
    .section-content { padding: 10px; }
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 5px;
    }
    .info-table td {
      border: 1px solid #666;
      padding: 4px 6px;
      vertical-align: top;
    }
    .info-table .label {
      font-weight: bold;
      background: #f5f5f5;
      width: 140px;
    }
    .text-field {
      border: 1px solid #666;
      min-height: 80px;
      padding: 6px;
      margin-top: 8px;
      white-space: pre-wrap;
    }
    .text-field.small { min-height: 40px; }
    .field-label {
      font-weight: bold;
      margin-top: 12px;
      margin-bottom: 4px;
      display: block;
    }
    .signature-area {
      margin-top: 40px;
      text-align: center;
    }
    .signature-line {
      border-top: 1px solid #000;
      width: 350px;
      margin: 0 auto;
      padding-top: 6px;
    }
    .action-buttons {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-print { background: #3b82f6; color: white; }
    .btn-close { background: #6b7280; color: white; }
    @media print {
      .action-buttons { display: none !important; }
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <!-- Bot√µes -->
  <div class="action-buttons">
    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Imprimir</button>
    <button onclick="window.close()" class="btn btn-close">‚úñ Fechar</button>
  </div>

  <!-- Cabe√ßalho -->
  <div class="header">
    <h1>FICHA DE AVALIA√á√ÉO</h1>
  </div>

  <!-- Dados Pessoais -->
  <div class="section">
    <div class="section-header">
      Dados Pessoais do Paciente:
      <span style="float: right;">Data da Avalia√ß√£o: ${dataAvaliacao}</span>
    </div>
    <div class="section-content">
      <table class="info-table">
        <tr>
          <td class="label">Nome:</td>
          <td colspan="3">${escapeHtml(patient.full_name)}</td>
        </tr>
        <tr>
          <td class="label">Idade:</td>
          <td>${idade} anos</td>
          <td class="label">Sexo:</td>
          <td>${sexo}</td>
        </tr>
        <tr>
          <td class="label">Profiss√£o:</td>
          <td>___________________</td>
          <td class="label">Hobbies:</td>
          <td>___________________</td>
        </tr>
        <tr>
          <td class="label">Peso:</td>
          <td>${peso}</td>
          <td class="label">Altura:</td>
          <td>${altura}</td>
        </tr>
        <tr>
          <td class="label">Estado Civil:</td>
          <td>___________________</td>
          <td class="label">CPF:</td>
          <td>${cpf}</td>
        </tr>
        <tr>
          <td class="label">Endere√ßo:</td>
          <td colspan="3">_________________________________________________</td>
        </tr>
        <tr>
          <td class="label">Telefone:</td>
          <td>___________________</td>
          <td class="label">CEP:</td>
          <td>___________________</td>
        </tr>
        <tr>
          <td class="label">Fisioterapeuta:</td>
          <td colspan="3">${escapeHtml(fisioterapeutaNome)}</td>
        </tr>
        <tr>
          <td class="label">CREFITO:</td>
          <td colspan="3">${escapeHtml(fisioterapeutaCrefito)}</td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Diagn√≥stico Cl√≠nico -->
  <div class="section">
    <div class="section-header">Diagn√≥stico Cl√≠nico:</div>
    <div class="section-content">
      <div class="text-field small">${diagnostico}</div>
    </div>
  </div>

  <!-- Anamnese -->
  <div class="section">
    <div class="section-header">Anamnese:</div>
    <div class="section-content">
      <span class="field-label">Queixa Principal:</span>
      <div class="text-field">${queixaPrincipal}</div>
      
      <span class="field-label">Hist√≥rico da Doen√ßa Atual:</span>
      <div class="text-field">${historicoAtual}</div>
      
      <span class="field-label">Hist√≥rico da Doen√ßa Pregressa:</span>
      <div class="text-field"></div>
      
      <span class="field-label">Doen√ßas Associadas:</span>
      <div class="text-field">${condicoes}</div>
      
      <span class="field-label">H√°bitos de Vida:</span>
      <div class="text-field"></div>
      
      <span class="field-label">Hist√≥rico Familiar:</span>
      <div class="text-field"></div>
      
      <span class="field-label">Medica√ß√µes em uso:</span>
      <div class="text-field"></div>
    </div>
  </div>

  <!-- Condi√ß√µes Pessoais -->
  <div class="section">
    <div class="section-header">Condi√ß√µes Pessoais</div>
    <div class="section-content">
      <span class="field-label">Alergias:</span>
      <div class="text-field small">${alergias}</div>
    </div>
  </div>

  <!-- Assinatura -->
  <div class="signature-area">
    <div class="signature-line">
      <div style="margin-bottom: 5px;">_________________________________</div>
      <strong>Fisioterapeuta Respons√°vel</strong><br>
      ${escapeHtml(fisioterapeutaNome)}<br>
      CREFITO: ${escapeHtml(fisioterapeutaCrefito)}
    </div>
    <div style="margin-top: 20px; font-size: 10pt;">
      Data: ${dataAvaliacao}
    </div>
  </div>
</body>
</html>
  `;
  
  return html;
}

/**
 * Helper: Formata alergias
 */
function formatAllergies(jsonStr) {
  try {
    var allergies = JSON.parse(jsonStr || '[]');
    return Array.isArray(allergies) && allergies.length > 0 
      ? escapeHtml(allergies.join(', '))
      : 'Nenhuma alergia registrada';
  } catch (e) {
    return 'Nenhuma alergia registrada';
  }
}

/**
 * Helper: Formata condi√ß√µes
 */
function formatConditions(jsonStr) {
  try {
    var conditions = JSON.parse(jsonStr || '[]');
    return Array.isArray(conditions) && conditions.length > 0 
      ? escapeHtml(conditions.join(', '))
      : 'Nenhuma condi√ß√£o registrada';
  } catch (e) {
    return 'Nenhuma condi√ß√£o registrada';
  }
}

/**
 * Helper: Formata CPF
 */
function formatCPF(cpf) {
  if (!cpf) return '';
  var numeros = String(cpf).replace(/\D/g, '');
  return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

/**
 * ‚úÖ ATUALIZA: Fun√ß√£o handleReportGeneration
 * Adicione esta modifica√ß√£o na fun√ß√£o existente
 */
function handleReportGenerationUpdated(e) {
  e.preventDefault();
  
  var patientId = document.getElementById('report-patient-select').value;
  var reportType = document.getElementById('report-type').value;
  // Formato √∫nico: Google Docs (sem impress√£o direta)
  var format = 'docs';
  
  if (!patientId) {
    showError('Selecione um paciente');
    return;
  }
  
  var params = {
    patient_id: patientId,
    type: reportType,
    format: format
  };
  
  // Adiciona per√≠odo se for evolu√ß√£o
  if (reportType === 'evolucao') {
    params.date_start = document.getElementById('report-date-start').value;
    params.date_end = document.getElementById('report-date-end').value;
  }
  
  debugLog('üìÑ Gerando relat√≥rio...', params);
  
  // Gera√ß√£o √∫nica: abre no Google Docs
  generatePDFReportUpdated(params);
}

/**
 * ‚úÖ Gera PDF via Google Docs
 */
function generatePDFReportUpdated(params) {
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result && result.success && result.url) {
        showSuccess('Documento gerado no Google Docs!');
        
        // Abre o Google Docs em nova aba
        window.open(result.url, '_blank');
        
        // Adiciona ao hist√≥rico
        addReportToHistory({
          name: result.file_name,
          url: result.url,
          date: new Date().toISOString()
        });
      } else {
        showError('Erro ao gerar documento');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('Erro ao gerar documento: ' + (error.message || error));
    })
    .generateDocsReport(params);
}

/**
 * ‚úÖ Adiciona relat√≥rio ao hist√≥rico visual
 */
function addReportToHistory(report) {
  var historyEl = document.getElementById('reports-history');
  if (!historyEl) return;
  
  var html = `
    <div class="bg-white border rounded p-3 flex justify-between items-center">
      <div>
        <p class="font-medium text-gray-800">${escapeHtml(report.name)}</p>
        <p class="text-xs text-gray-500">${formatDateTimeBR(report.date)}</p>
      </div>
      <a href="${report.url}" target="_blank" 
         class="text-blue-600 hover:text-blue-800 text-sm">
        <i class="fas fa-external-link-alt mr-1"></i>Abrir
      </a>
    </div>
  `;
  
  // Remove mensagem de "nenhum relat√≥rio"
  if (historyEl.querySelector('p.italic')) {
    historyEl.innerHTML = '';
  }
  
  // Adiciona no topo
  historyEl.insertAdjacentHTML('afterbegin', html);
}

/**
 * Helper: Formata data/hora BR
 */
function formatDateTimeBR(isoDate) {
  if (!isoDate) return '';
  
  try {
    var date = new Date(isoDate);
    var day = ('0' + date.getDate()).slice(-2);
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var year = date.getFullYear();
    var hours = ('0' + date.getHours()).slice(-2);
    var minutes = ('0' + date.getMinutes()).slice(-2);
    
    return `${day}/${month}/${year} √†s ${hours}:${minutes}`;
  } catch (e) {
    return '';
  }
}

console.log('‚úÖ M√≥dulo de Ficha de Avalia√ß√£o carregado');
</script>
<script>
// ============================================================================
// RELAT√ìRIOS - Integra√ß√£o do cart√£o e formul√°rio
// Adiciona handlers ausentes: selectReportType, cancelReportSelection,
// carregamento de pacientes e binding do submit do formul√°rio
// ============================================================================

var currentReportType = null;

function selectReportType(type) {
  try {
    currentReportType = type;

    var container = document.getElementById('report-form-container');
    if (container) container.classList.remove('hidden');

    var typeInput = document.getElementById('report-type');
    if (typeInput) typeInput.value = type;

    loadPatientsForReport();

    var periodContainer = document.getElementById('report-period-container');
    if (periodContainer) {
      if (type === 'evolucao') {
        periodContainer.classList.remove('hidden');
        setDefaultDates();
      } else {
        periodContainer.classList.add('hidden');
      }
    }

    if (container && container.scrollIntoView) {
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  } catch (e) {
    console.error('Erro em selectReportType:', e);
  }
}

function cancelReportSelection() {
  try {
    var container = document.getElementById('report-form-container');
    if (container) container.classList.add('hidden');
    var form = document.getElementById('report-generation-form');
    if (form) form.reset();
    currentReportType = null;
  } catch (e) {
    console.error('Erro em cancelReportSelection:', e);
  }
}

function loadPatientsForReport() {
  var select = document.getElementById('report-patient-select');
  if (!select) return;

  select.innerHTML = '<option value="">Carregando pacientes...</option>';

  if (Array.isArray(INITIAL_PATIENTS) && INITIAL_PATIENTS.length > 0) {
    populateReportPatientSelect(INITIAL_PATIENTS);
    return;
  }

  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    select.innerHTML = '<option value="">google.script.run indispon√≠vel</option>';
    return;
  }

  google.script.run
    .withSuccessHandler(function(patients){
      populateReportPatientSelect(patients || []);
    })
    .withFailureHandler(function(err){
      console.error('Erro ao carregar pacientes:', err);
      select.innerHTML = '<option value="">Erro ao carregar pacientes</option>';
    })
    .getFrontendPatients();
}

function populateReportPatientSelect(patients) {
  var select = document.getElementById('report-patient-select');
  if (!select) return;

  var html = '<option value="">Selecione um paciente...</option>';
  patients.forEach(function(p){
    var age = calculateAge(p.birth_date);
    var cpf = p.document_id ? ' - CPF: ' + p.document_id : '';
    html += '<option value="' + p.id + '">' + escapeHtml(p.full_name) + ' (' + age + ' anos)' + cpf + '</option>';
  });
  select.innerHTML = html;
}

function setDefaultDates() {
  var today = new Date();
  var thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(today.getDate() - 30);
  var startInput = document.getElementById('report-date-start');
  var endInput = document.getElementById('report-date-end');
  if (startInput) startInput.value = formatDateForInput(thirtyDaysAgo);
  if (endInput) endInput.value = formatDateForInput(today);
}

function formatDateForInput(date) {
  var y = date.getFullYear();
  var m = ('0' + (date.getMonth() + 1)).slice(-2);
  var d = ('0' + date.getDate()).slice(-2);
  return y + '-' + m + '-' + d;
}

document.addEventListener('DOMContentLoaded', function(){
  var form = document.getElementById('report-generation-form');
  if (form) {
    // Usa a fun√ß√£o atualizada que decide entre impress√£o e PDF
    form.addEventListener('submit', handleReportGenerationUpdated);
  }
});
</script>
<script>
// =============================================================================
// Navega√ß√£o lateral (router por hash) + Drawer base
// =============================================================================

(function initShell() {
  document.addEventListener('DOMContentLoaded', function() {
    // Sidebar links ‚Üí navega√ß√£o por hash
    var items = document.querySelectorAll('#sidebar [data-route]');
    for (var i=0;i<items.length;i++){
      items[i].addEventListener('click', function(e){
        var route = this.getAttribute('data-route');
        if(route){ location.hash = route; }
        closeSidebarMobile();
      });
    }

    // Bot√£o para abrir sidebar no mobile
    var btn = document.getElementById('btn-open-sidebar');
    if (btn) btn.addEventListener('click', openSidebarMobile);

    // Router por hash
    window.addEventListener('hashchange', applyRoute);
    applyRoute(); // rota inicial
  });
})();

function applyRoute(){
  var hash = location.hash || '#/dashboard';
  var map = {
    '#/dashboard': 'dashboard',
    '#/pacientes': 'patients',
    '#/atendimentos': 'encounters',
    '#/relatorios': 'reports'
  };
  var tab = map[hash] || 'dashboard';
  try { showTab(tab); } catch(e) {}

  // Ativa item no sidebar
  var items = document.querySelectorAll('#sidebar [data-route]');
  for (var i=0;i<items.length;i++){
    var it = items[i];
    if (it.getAttribute('data-route') === hash) { it.classList.add('is-active'); } else { it.classList.remove('is-active'); }
  }
  // Atualiza t√≠tulo
  var title = document.getElementById('page-title');
  if (title){
    var titles = {dashboard:'Dashboard',patients:'Pacientes',encounters:'Atendimentos',reports:'Relat√≥rios'};
    title.textContent = titles[tab] || 'Fisio System';
  }
}

function openSidebarMobile(){
  var overlay = document.getElementById('sidebar-overlay');
  var aside = document.getElementById('sidebar');
  if (overlay) overlay.classList.remove('hidden');
  if (aside) aside.classList.remove('hidden');
}
function closeSidebarMobile(){
  var overlay = document.getElementById('sidebar-overlay');
  var aside = document.getElementById('sidebar');
  if (overlay) overlay.classList.add('hidden');
  if (aside && window.innerWidth < 1024) aside.classList.add('hidden');
}

// Drawer base reutiliz√°vel
function openDrawer(opts){
  var el = document.getElementById('drawer');
  if (!el) return;
  document.getElementById('drawer-title').textContent = (opts && opts.title) || '';
  document.getElementById('drawer-body').innerHTML = (opts && opts.bodyHtml) || '';
  var primary = document.getElementById('drawer-primary');
  if (primary){
    primary.onclick = function(){ if (opts && typeof opts.onPrimary === 'function') opts.onPrimary(); };
    primary.textContent = (opts && opts.primaryText) || 'Confirmar';
  }
  el.classList.remove('hidden');
}
function closeDrawer(){
  var el = document.getElementById('drawer');
  if (el) el.classList.add('hidden');
}
</script>


